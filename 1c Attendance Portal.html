<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KIIT Attendance App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --color-bg: #f7f7f9;
      --color-surface: #ffffff;
      --color-border-soft: #e3e3e8;
      --color-text: #111827;
      --color-muted: #6b7280;
      --shadow-soft: 0 1px 3px rgba(15, 23, 42, 0.06);
      --radius-medium: 8px;
      --radius-small: 4px;
      --transition-fast: 0.15s ease-in-out;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
    }
    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem 0.75rem 1.5rem;
    }
    header { margin-bottom: 0.5rem; }

    .header-top-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.75rem;
      align-items: center;
    }
    #sync-status {
      font-size: 0.75rem;
      color: var(--color-muted);
      margin-top: 2px;
    }
    #sync-status strong { color: #111827; }

    .class-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .class-radios {
      display: inline-flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .class-radio-label {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0.1rem 0.35rem;
      border-radius: 999px;
      border: 1px solid transparent;
      transition: background-color var(--transition-fast), border-color var(--transition-fast);
    }
    .class-radio-label input { margin: 0; }
    .class-radio-label.active {
      background: #eef2ff;
      border-color: #4f46e5;
      color: #111827;
    }

    /* Summary row above section selection */
    .class-summary-row {
      margin: 0.5rem 0 0.75rem;
      font-size: 0.85rem;
      color: #374151;
    }
    .class-summary-row strong {
      font-weight: 700;
      color: #111827;
    }

    .nav-tabs {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0;
      margin-bottom: 0.75rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .nav-segments {
      display: inline-flex;
      background: #e5e7eb;
      padding: 2px;
      border-radius: 999px;
    }
    .nav-button {
      border: none;
      background: transparent;
      padding: 0.4rem 0.9rem;
      font-size: 0.875rem;
      border-radius: 999px;
      cursor: pointer;
      color: var(--color-muted);
      transition: background-color var(--transition-fast), color var(--transition-fast);
      white-space: nowrap;
    }
    .nav-button.active {
      background: #ffffff;
      color: #111827;
      box-shadow: var(--shadow-soft);
    }

    .card {
      background: var(--color-surface);
      border-radius: var(--radius-medium);
      box-shadow: var(--shadow-soft);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      outline: none;
      padding: 2px 4px;
      border-radius: var(--radius-small);
      margin: 0;
    }
    .section-title:focus { background: #eef2ff; }
    .card-subtitle { font-size: 0.8rem; color: var(--color-muted); margin: 0.25rem 0 0; }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1;
    }
    label { font-size: 0.75rem; color: var(--color-muted); }
    input[type="text"], input[type="date"], input[type="tel"], input[type="file"], input[type="number"], textarea, select {
      border-radius: var(--radius-small);
      border: 1px solid var(--color-border-soft);
      padding: 0.35rem 0.5rem;
      font-size: 0.85rem;
      width: 100%;
      background: #f9fafb;
      transition: border-color var(--transition-fast), background-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    textarea { resize: vertical; min-height: 40px; }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      background: #fff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 0.35rem 0.8rem;
      font-size: 0.8rem;
      cursor: pointer;
      color: #111827;
      transition: background-color var(--transition-fast), transform var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
      white-space: nowrap;
    }
    .btn:hover { background: #f3f4f6; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { border-color: #2563eb; color: #fff; background: #2563eb; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-outline { border-color: #d1d5db; }
    .btn-danger-soft { border-color: transparent; background: #ffe5e5; color: #b91c1c; }
    .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.75rem; }

    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: var(--radius-medium);
      border: 1px solid #e5e7eb;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 650px;
      font-size: 0.8rem;
    }
    thead { background: #f3f4f6; }
    th, td {
      text-align: left;
      padding: 0.25rem 0.5rem;
      border-bottom: 1px solid #f1f1f3;
      white-space: nowrap;
      vertical-align: middle;
    }
    th {
      font-weight: 500;
      font-size: 0.75rem;
      color: #6b7280;
      background: #f3f4f6;
    }
    th.sortable, th.sortable-roster, #mentor-table thead th.sortable-mentor { cursor: pointer; }
    tbody tr { transition: background-color var(--transition-fast); }

    /* Keep ONLY Msgs header sticky while scrolling page */
    #reports-table thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: #f3f4f6;
    }

    /* Msgs table banding + hover */
    #reports-table tbody tr:nth-child(even) { background: #f9fafb; }
    #reports-table tbody tr:hover { background: #fde68a !important; }

    tbody tr.absent { background: #ffe5e5; }

    .table-actions { display: inline-flex; gap: 0.25rem; }
    .checkbox-cell { text-align: center; width: 56px; }
    .checkbox-large { width: 18px; height: 18px; }

    .percent-cell { font-variant-numeric: tabular-nums; font-weight: 600; color: #059669; }
    .badge {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 0.1rem 0.4rem; font-size: 0.7rem;
      border-radius: 999px; background: #e5e7eb; min-width: 1.4rem;
    }

    .name-with-percent { color: #059669; font-weight: 600; }
    .name-main { color: #111827; font-weight: 600; margin-right: 4px; }

    .history-pill { display: inline-flex; gap: 0.1rem; font-size: 0.7rem; align-items: center; }
    .history-dot {
      width: 14px; height: 14px; border-radius: 999px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.6rem; font-weight: 700; color: #111827;
    }
    .history-p { background: #bbf7d0; }
    .history-a { background: #fecaca; }
    .history-empty { background: #e5e7eb; }

    .empty-state { padding: 0.5rem 0; color: var(--color-muted); font-size: 0.8rem; }

    .attendance-saved-border {
      border-color: #16a34a !important;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.25);
    }

    /* Disabled row highlight (used across sections) */
    .disabled-row {
      background: #fee2e2 !important;
    }
    .disabled-text {
      color: #b91c1c;
      font-weight: 600;
    }

    /* Msgs Attendance markers */
    .att-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 800;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .att-badge-a {
      background: #fecaca;
      color: #7f1d1d;
    }
    .att-badge-p {
      background: #bbf7d0;
      color: #065f46;
    }

    /* Mentor inline radio inputs */
    .mentor-inline {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }
    .mentor-inline input[type="number"]{
      width: 72px;
      padding: 0.25rem 0.4rem;
      font-size: 0.8rem;
      background: #fff;
    }
    .mentor-inline .mentor-inline-num[disabled]{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 0.75rem;
    }
    .modal {
      background: #ffffff;
      border-radius: var(--radius-medium);
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.18);
      max-width: 520px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 0.75rem 1rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .modal-title { margin: 0; font-size: 0.95rem; font-weight: 600; }
    .modal-body { padding: 0.75rem 1rem; overflow-y: auto; font-size: 0.8rem; }
    .modal-footer {
      padding: 0.5rem 1rem 0.75rem;
      border-top: 1px solid #e5e7eb;
      text-align: right;
    }
    .remarks-list { list-style: none; padding: 0; margin: 0; }
    .remarks-list li { padding: 0.35rem 0; border-bottom: 1px dashed #e5e7eb; }
    .remarks-date { font-size: 0.7rem; color: #6b7280; }
    .remarks-text { margin-top: 2px; }

    @media (max-width: 640px) {
      .card { padding: 0.75rem; }
      .header-top-row { flex-direction: column; align-items: flex-start; }
      table { min-width: 600px; }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header>
      <div class="header-top-row">
        <div>
          <strong>KIIT Attendance App</strong>
          <div id="sync-status">Sync: <strong>starting…</strong></div>
        </div>

        <div class="header-actions">
          <button id="settings-btn" class="btn btn-sm btn-outline" type="button">Settings</button>
          <button id="backup-btn" class="btn btn-sm btn-outline" type="button">Backup</button>
          <input id="restore-file-input" type="file" accept=".json" style="display:none;" />
          <button id="restore-btn" class="btn btn-sm btn-outline" type="button">Restore</button>
          <button id="export-class-excel-btn" class="btn btn-sm btn-outline" type="button">Export to Excel</button>
        </div>
      </div>

      <div class="class-bar">
        <span></span>
        <div id="class-radios" class="class-radios"></div>
      </div>
    </header>

    <!-- Class summary just above section selection row -->
    <div class="class-summary-row">
      <span id="class-summary"></span>
    </div>

    <div class="nav-tabs">
      <div class="nav-segments" id="nav-segments"></div>
    </div>

    <!-- ROSTER -->
    <section id="roster-section" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <h2 class="section-title" contenteditable="true" spellcheck="false">Data</h2>
          <!-- <p class="card-subtitle">Maintain the list of students, import from XLS, and manage contact details.</p> -->
        </div>
        <div class="table-actions">
          <button id="roster-select-all-btn" class="btn btn-sm btn-outline" type="button">Select All</button>
          <button id="roster-delete-selected-btn" class="btn btn-sm btn-danger-soft" type="button">Delete Selected</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="roll-input">Roll</label>
          <input id="roll-input" type="text" placeholder="e.g. 210001" />
        </div>
        <div class="form-group">
          <label for="name-input">Name</label>
          <input id="name-input" type="text" placeholder="Student name" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="student-phone-input">Student Phone</label>
          <input id="student-phone-input" type="tel" placeholder="10-digit mobile number" />
        </div>
        <div class="form-group">
          <label for="parent-phone-input">Parent Phone</label>
          <input id="parent-phone-input" type="tel" placeholder="10-digit mobile number" />
        </div>
      </div>

      <!-- Disable student toggle -->
      <div class="form-row" style="align-items:center;margin-top:-0.3rem;">
        <div class="form-group" style="flex:0 0 auto;">
          <label style="display:flex;align-items:center;gap:0.25rem;">
            <input id="disabled-input" type="checkbox" />
            <span>Disable (debarred / special case)</span>
          </label>
        </div>
      </div>

      <div class="form-row" style="align-items:flex-end;">
        <div class="form-group">
          <label for="email-display">Email (auto from roll)</label>
          <input id="email-display" type="text" placeholder="ROLL@kiit.ac.in" disabled />
        </div>
        <div class="form-group" style="flex:0 0 auto;">
          <button id="save-student-btn" class="btn btn-primary btn-sm"><span id="save-student-label">Add Student</span></button>
        </div>
      </div>

      <div class="form-row" style="align-items:flex-end;">
        <div class="form-group">
          <label for="xls-file-input">Import XLS / XLSX (A=Roll, B=Name, C=Student Phone, E=Parent Phone)</label>
          <input id="xls-file-input" type="file" accept=".xls,.xlsx" />
        </div>
        <div class="form-group" style="flex:0 0 auto;">
          <button id="import-xls-btn" class="btn btn-outline btn-sm" type="button">Import XLS</button>
        </div>
      </div>
      <div id="import-xls-status" style="margin-top:-0.35rem;font-size:0.75rem;color:#6b7280;"></div>

      <div class="table-container">
        <table id="roster-table">
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" id="roster-header-checkbox" /></th>
              <th class="sortable-roster" data-sort-field="sno" style="width:50px;">S.No</th>
              <th class="sortable-roster" data-sort-field="roll" style="width:90px;">Roll</th>
              <th class="sortable-roster" data-sort-field="name">Name</th>
              <th style="width:50px;">Status</th>
              <th>Student Phone</th>
              <th>Parent Phone</th>
              <th>Email</th>
              <th style="width:110px;">Actions</th>
            </tr>
          </thead>
          <tbody id="roster-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- MARK -->
    <section id="attendance-section" class="card" style="display:none;">
      <div class="form-row" style="align-items:flex-end;">
        <div class="form-group" style="flex:0 0 220px;max-width:260px;">
          <label for="attendance-date-input">Date</label>
          <input id="attendance-date-input" type="date" />
          <div id="attendance-class-count" style="font-size:0.72rem;color:#6b7280;margin-top:2px;"></div>
          <div id="attendance-present-today" style="font-size:0.72rem;color:#6b7280;margin-top:2px;"></div>
        </div>
        <div class="form-group" style="flex:1;text-align:right;">
          <button id="export-excel-btn" class="btn btn-sm btn-outline" type="button">Today's Excel</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="attendance-notes-input">Session notes (optional)</label>
          <textarea id="attendance-notes-input" placeholder="e.g. Internal test, lab, etc."></textarea>
        </div>
      </div>

      <div class="form-row" style="align-items:flex-end;margin-top:-0.5rem;">
        <div class="form-group" style="flex:1;"></div>
        <div class="form-group" style="flex:0 0 auto;text-align:right;">
          <button id="clear-day-btn" class="btn btn-sm btn-outline" type="button" style="display:none;">Clear This Day</button>
        </div>
      </div>

      <div id="attendance-table-wrapper" class="table-container">
        <table id="attendance-table">
          <thead>
            <tr>
              <th style="width:80px;">Last 3</th>
              <th style="width:90px;">Roll</th>
              <th>
                <div style="display:flex;align-items:center;gap:4px;">
                  <input id="toggle-all-checkbox" type="checkbox" class="checkbox-large" />
                  <span>Name (with %)</span>
                </div>
              </th>
              <th>Remarks</th>
              <th class="checkbox-cell">Present?</th>
            </tr>
          </thead>
          <tbody id="attendance-tbody"></tbody>
        </table>
      </div>

      <div style="margin-top:0.5rem;text-align:right;">
        <button id="save-session-btn" class="btn btn-primary btn-sm" type="button">Save Attendance Session</button>
      </div>
    </section>

    <!-- MSGS -->
    <section id="reports-section" class="card" style="display:block;">
      <div id="reports-classes-summary" style="font-size:0.8rem;color:#4b5563;margin-bottom:0.5rem;"></div>

      <!-- Action selector (no apply button) -->
      <div class="form-row" style="align-items:center;margin-bottom:0.5rem;">
        <div class="form-group" style="flex:0 0 auto;">
          <label for="reports-action-select">Row action</label>
          <select id="reports-action-select" style="padding:0.25rem 0.5rem;font-size:0.8rem;">
            <option value="wa-student">WhatsApp Student</option>
            <option value="wa-parent">WhatsApp Parent</option>
            <option value="email-student">Email Student</option>
            <option value="email-parent-cc-student">Email Parent (cc Student)</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table id="reports-table">
          <thead><tr id="reports-header-row"></tr></thead>
          <tbody id="reports-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- MENTOR -->
    <section id="mentor-section" class="card" style="display:none;">
      <div class="form-row" style="align-items:flex-start;">
        <div class="form-group" style="flex:1;">
          <label>Report Type</label>

          <div class="mentor-inline">
            <label style="display:inline-flex;align-items:center;gap:0.35rem;cursor:pointer;">
              <input type="radio" name="mentor-report-type" value="consecutive" checked />
              <span>Consecutive absences (last</span>
              <input id="mentor-consecutive-input" class="mentor-inline-num" type="number" min="1" value="2" />
              <span>classes)</span>
            </label>

            <label style="display:inline-flex;align-items:center;gap:0.35rem;cursor:pointer;">
              <input type="radio" name="mentor-report-type" value="percentage" />
              <span>Below attendance % threshold</span>
              <input id="mentor-percent-input" class="mentor-inline-num" type="number" min="0" max="100" value="75" disabled />
            </label>
          </div>
        </div>
      </div>

      <!-- Buttons in ONE row, above the table -->
      <div class="form-row" style="align-items:center;justify-content:flex-end;margin-top:-0.25rem;">
        <div class="form-group" style="flex:0 0 auto;display:flex;flex-direction:row;gap:0.4rem;align-items:center;justify-content:flex-end;">
          <button id="mentor-copy-wa-btn" class="btn btn-outline btn-sm" type="button">Copy List</button>
          <button id="generate-mentor-report-btn" class="btn btn-primary btn-sm" type="button">Generate List</button>
          <button id="export-mentor-report-btn" class="btn btn-outline btn-sm" type="button">Export list</button>
        </div>
      </div>

      <div id="mentor-summary" style="font-size:0.8rem;color:#4b5563;margin-bottom:0.5rem;"></div>

      <div class="table-container" id="mentor-table-container" style="display:none;">
        <table id="mentor-table">
          <thead>
            <tr>
              <th class="sortable-mentor" data-sort-field="sno" style="width:50px;">S.No</th>
              <th class="sortable-mentor" data-sort-field="roll" style="width:90px;">Roll</th>
              <th class="sortable-mentor" data-sort-field="name">Name</th>
              <th class="sortable-mentor" data-sort-field="attendance" style="width:120px;">Attendance</th>
              <th class="sortable-mentor" data-sort-field="detail">Details</th>
            </tr>
          </thead>
          <tbody id="mentor-tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Remarks Modal -->
  <div id="remarks-modal-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="remarks-modal-title">
      <div class="modal-header">
        <h3 id="remarks-modal-title" class="modal-title">Remarks</h3>
        <button type="button" class="btn btn-sm" id="close-remarks-modal-btn">Close</button>
      </div>
      <div class="modal-body">
        <div id="remarks-modal-meta" style="margin-bottom:0.5rem;font-size:0.8rem;color:#6b7280;"></div>
        <ul id="remarks-modal-list" class="remarks-list"></ul>
        <div id="remarks-modal-empty" class="empty-state" style="display:none;">No remarks recorded for this student.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-sm" id="remarks-modal-ok-btn">OK</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
      <div class="modal-header">
        <h3 id="settings-modal-title" class="modal-title">Templates Settings</h3>
        <button type="button" class="btn btn-sm" id="close-settings-modal-btn">Close</button>
      </div>
      <div class="modal-body">
        <p style="margin-top:0;margin-bottom:0.5rem;font-size:0.8rem;color:#6b7280;">
          Use placeholders:
          <code>{name}</code>, <code>{roll}</code>, <code>{percent}</code>, <code>{remarks}</code>,
          <code>{class name}</code>, <code>{total number of classes}</code>, <code>{Classes you are present}</code>.
        </p>

        <div class="form-group" style="margin-bottom:0.75rem;">
          <label for="settings-wa-student-template" style="font-weight:600;">WhatsApp template (Student)</label>
          <textarea id="settings-wa-student-template" style="min-height:60px;"></textarea>
        </div>

        <div class="form-group" style="margin-bottom:0.75rem;">
          <label for="settings-wa-parent-template" style="font-weight:600;">WhatsApp template (Parent)</label>
          <textarea id="settings-wa-parent-template" style="min-height:60px;"></textarea>
        </div>

        <div class="form-group" style="margin-bottom:0.75rem;">
          <label for="settings-student-email-template" style="font-weight:600;">Student email template</label>
          <textarea id="settings-student-email-template" style="min-height:60px;"></textarea>
        </div>

        <div class="form-group">
          <label for="settings-parent-email-template" style="font-weight:600;">Parent email template</label>
          <textarea id="settings-parent-email-template" style="min-height:60px;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline btn-sm" id="settings-cancel-btn">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="settings-save-btn">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const APP_SECTIONS = [
      { id: "roster-section", label: "Data" },
      { id: "attendance-section", label: "Mark" },
      { id: "reports-section", label: "Msgs" },
      { id: "mentor-section", label: "Mentor" }
    ];

    const CLASS_CONFIG = [
      { key: "Section A", label: "A23 BEE", classCode: "EE10002", sapKey: "0900" },
      { key: "Section B", label: "4EL2 Ind 4.0", classCode: "EX20001", sapKey: "1100" },
      { key: "Section C", label: "SDT", classCode: "EE30021", sapKey: "" },
      { key: "Section D", label: "6EL1 Drives Lab", classCode: "EE39004", sapKey: "0900" },
      { key: "Section E", label: "6EL1 MP lab", classCode: "EE39006", sapKey: "1200" },
      { key: "Section F", label: "Vocational Lab", classCode: "EE28017", sapKey: "1200" }
    ];

    const TEMPLATE_CONFIG_DEFAULTS = {
      whatsappStudentTemplate:
        "Dear {name} ({roll}), from class {class name}, your current attendance is {percent}% out of {total number of classes} classes, and you were present in {Classes you are present} classes. Remarks: {remarks}",
      whatsappParentTemplate:
        "Dear Parent of {name} ({roll}) from class {class name}, your ward's attendance is {percent}% out of {total number of classes} classes, and they were present in {Classes you are present} classes. Remarks: {remarks}",
      studentEmailTemplate:
        "Dear {name},\nYou belong to class {class name}.\nYour attendance is {percent}% with presence in {Classes you are present} out of {total number of classes} classes.\nRemarks: {remarks}",
      parentEmailTemplate:
        "Dear Parent of {name} ({roll}),\nYour ward is in class {class name}.\nTheir attendance is {percent}% with presence in {Classes you are present} out of {total number of classes} classes.\nRemarks: {remarks}"
    };

    const WHATSAPP_CONFIG = {
      buttonLabel: "WhatsApp",
      apiBase: "https://cloud.wazbulk.in/api/send",
      instanceId: "xyzxyzxyz",
      accessToken: "abccabcabcabcabc"
    };

    const STORAGE_KEY = "kiitAttendanceData_2026_1";

    // =========================
    // SERVER (sekr.in)
    // =========================
    const REMOTE_API_URL   = "https://sekr.in/wp-json/kiit-att/v1/data";
    const REMOTE_PING_URL  = "https://sekr.in/wp-json/kiit-att/v1/ping";
    const REMOTE_TEST_URL  = "https://sekr.in/wp-json/kiit-att/v1/token-test";

    const REMOTE_API_TOKEN = "tROGebnby7DfGh7qpn24M0mKA5OiBrW5b3e7xqGT";

    const syncStatusEl = document.getElementById("sync-status");
    function setSyncStatus(text) {
      if (syncStatusEl) syncStatusEl.innerHTML = 'Sync: <strong>' + text + '</strong>';
    }

    // =========================
    // DATA MODEL
    // =========================
    const classes = {};
    let currentClassKey = CLASS_CONFIG[0].key;
    let currentSession = { date: "", notes: "", marks: {} };

    const appSettings = {
      whatsappStudentTemplate: TEMPLATE_CONFIG_DEFAULTS.whatsappStudentTemplate,
      whatsappParentTemplate: TEMPLATE_CONFIG_DEFAULTS.whatsappParentTemplate,
      studentEmailTemplate: TEMPLATE_CONFIG_DEFAULTS.studentEmailTemplate,
      parentEmailTemplate: TEMPLATE_CONFIG_DEFAULTS.parentEmailTemplate
    };

    let rosterSort = { field: "sno", dir: "asc" };
    let reportSort = { field: "roll", dir: "asc" };
    let mentorSort = { field: "roll", dir: "asc" };
    let lastMentorReport = []; // in the same order as displayed

    function ensureClass(key) {
      if (!classes[key]) classes[key] = { students: [], sessionsByDate: {} };
      return classes[key];
    }
    function getCurrentClass() { return ensureClass(currentClassKey); }
    function getStudents() { return getCurrentClass().students; }
    function getSessionsByDate() { return getCurrentClass().sessionsByDate; }

    function generateId() { return "s_" + Math.random().toString(36).substr(2, 9); }
    function toTitleCase(name) {
      if (!name) return "";
      return name.toLowerCase().split(/\s+/).filter(Boolean)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
    }
    function findStudentById(id) { return getStudents().find(s => s.id === id) || null; }
    function findStudentByRoll(roll) { return getStudents().find(s => s.roll === roll) || null; }
    function getCurrentClassMeta() { return CLASS_CONFIG.find(c => c.key === currentClassKey) || null; }

    // =========================
    // COMPUTATIONS
    // =========================
    function computePercentWithPreview(student) {
      const st = getStudents().find(s => s.id === student.id) || student;
      let baseTotal = st.totalSessions || 0;
      let basePresents = st.disabled ? 0 : (st.presents || 0);

      const previewMark = currentSession.marks[st.id];
      if (previewMark && currentSession.date) {
        baseTotal += 1;
        if (!st.disabled && previewMark.present) basePresents += 1;
      }
      if (baseTotal === 0) return 0;
      return Math.round(100 * basePresents / baseTotal);
    }

    function updateClassSummary() {
      const el = document.getElementById("class-summary");
      const students = getStudents();
      const total = students.length;
      const meta = getCurrentClassMeta();
      const code = meta ? meta.classCode : "";
      const name = meta ? meta.label : currentClassKey;
      const classInfo = code ? (name + " (" + code + ")") : name;

      if (total === 0) { el.innerHTML = "<strong>" + classInfo + "</strong> (no students loaded)"; return; }
      const avg = Math.round(students.reduce((sum, s) => sum + computePercentWithPreview(s), 0) / total);
      el.innerHTML = "<strong>" + classInfo + "</strong> (" + total + " Stu, Avg " + avg + "%)";
    }

    function computeLast3HistoryWithCurrent(st) {
      const sessionsByDate = getSessionsByDate();
      const dates = Object.keys(sessionsByDate).sort();
      const historyPairs = dates.map(d => {
        const sess = sessionsByDate[d];
        const mark = sess && sess.marks && sess.marks[st.id];
        let val = null;
        if (mark) val = mark.present ? "P" : "A";
        return { date: d, val };
      }).filter(p => p.val !== null);

      if (currentSession && currentSession.date) {
        const d = currentSession.date;
        const mark = currentSession.marks[st.id];
        if (mark) {
          const val = mark.present ? "P" : "A";
          const idx = historyPairs.findIndex(p => p.date === d);
          if (idx >= 0) historyPairs[idx].val = val;
          else historyPairs.push({ date: d, val });
        }
      }

      historyPairs.sort((a, b) => a.date.localeCompare(b.date));
      return historyPairs.slice(-3).map(p => p.val);
    }

    function updateHistoryCellForStudent(st) {
      const history = computeLast3HistoryWithCurrent(st);
      const container = document.querySelector('[data-history-cell="' + st.id + '"]');
      if (!container) return;
      container.innerHTML = "";

      const dots = (!history.length) ? [null] : Array(3 - history.length).fill(null).concat(history);
      dots.forEach(val => {
        const dot = document.createElement("span");
        if (val === "P") { dot.className = "history-dot history-p"; dot.textContent = "P"; }
        else if (val === "A") { dot.className = "history-dot history-a"; dot.textContent = "A"; }
        else { dot.className = "history-dot history-empty"; dot.textContent = "-"; }
        container.appendChild(dot);
      });
    }

    function refreshAllHistoryCells() { getStudents().forEach(st => updateHistoryCellForStudent(st)); }

    // =========================
    // STORAGE (Local + Server)
    // =========================
    function buildAppDataObject() {
      return { classes, currentClassKey, appSettings, savedAt: new Date().toISOString() };
    }

    function saveToLocalStorage() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(buildAppDataObject())); }
      catch (e) { console.error("localStorage save failed", e); }
    }

    function applyLoadedData(parsed) {
      Object.keys(classes).forEach(k => delete classes[k]);
      Object.assign(classes, parsed.classes || {});

      const keysFromConfig = CLASS_CONFIG.map(c => c.key);
      currentClassKey = (parsed.currentClassKey && keysFromConfig.includes(parsed.currentClassKey))
        ? parsed.currentClassKey
        : keysFromConfig[0];

      const s = parsed.appSettings || {};
      appSettings.whatsappStudentTemplate = s.whatsappStudentTemplate || TEMPLATE_CONFIG_DEFAULTS.whatsappStudentTemplate;
      appSettings.whatsappParentTemplate  = s.whatsappParentTemplate  || TEMPLATE_CONFIG_DEFAULTS.whatsappParentTemplate;
      appSettings.studentEmailTemplate    = s.studentEmailTemplate    || TEMPLATE_CONFIG_DEFAULTS.studentEmailTemplate;
      appSettings.parentEmailTemplate     = s.parentEmailTemplate     || TEMPLATE_CONFIG_DEFAULTS.parentEmailTemplate;
    }

    function loadFromLocalStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!parsed || !parsed.classes) return false;
        applyLoadedData(parsed);
        return true;
      } catch (e) { return false; }
    }

    async function saveToServer() {
      if (!REMOTE_API_TOKEN || REMOTE_API_TOKEN === "PASTE_YOUR_TOKEN_HERE") {
        setSyncStatus("token missing (not saving)");
        return;
      }

      try {
        setSyncStatus("saving…");
        const res = await fetch(REMOTE_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-KIIT-TOKEN": REMOTE_API_TOKEN
          },
          body: JSON.stringify(buildAppDataObject())
        });

        const txt = await res.text();

        if (!res.ok) {
          console.error("SAVE FAILED:", res.status, txt);
          setSyncStatus("save failed (" + res.status + ")");
          return;
        }
        setSyncStatus("saved");
      } catch (e) {
        console.error("SAVE ERROR:", e);
        setSyncStatus("save error");
      }
    }

    async function loadFromServer() {
      try {
        setSyncStatus("loading…");
        const res = await fetch(REMOTE_API_URL, { method: "GET" });
        const txt = await res.text();

        if (!res.ok) {
          console.error("LOAD FAILED:", res.status, txt);
          setSyncStatus("load failed (" + res.status + ")");
          return false;
        }

        if (!txt) {
          setSyncStatus("server returned empty");
          return false;
        }

        const parsed = JSON.parse(txt);
        if (!parsed || typeof parsed !== "object" || !parsed.classes) {
          setSyncStatus("server data invalid");
          return false;
        }

        applyLoadedData(parsed);
        setSyncStatus(parsed.__empty ? "loaded (empty)" : "loaded");
        return true;
      } catch (e) {
        console.error("LOAD ERROR:", e);
        setSyncStatus("load error");
        return false;
      }
    }

    function saveAll() { saveToLocalStorage(); saveToServer(); }

    async function runServerDiagnostics() {
      try {
        const ping = await fetch(REMOTE_PING_URL);
        console.log("PING:", ping.status, await ping.text());

        if (!REMOTE_API_TOKEN || REMOTE_API_TOKEN === "PASTE_YOUR_TOKEN_HERE") {
          console.warn("Token missing; skipping token-test.");
          return;
        }

        const test = await fetch(REMOTE_TEST_URL, {
          headers: { "X-KIIT-TOKEN": REMOTE_API_TOKEN }
        });
        console.log("TOKEN-TEST:", test.status, await test.text());
      } catch (e) {
        console.error("Diagnostics error:", e);
      }
    }

    // =========================
    // NAV
    // =========================
    const navSegments = document.getElementById("nav-segments");
    const sections = {};
    const navButtons = [];

    APP_SECTIONS.forEach((sec) => {
      const btn = document.createElement("button");
      const isDefault = (sec.id === "reports-section");
      btn.className = "nav-button" + (isDefault ? " active" : "");
      btn.dataset.section = sec.id;
      btn.textContent = sec.label;
      navSegments.appendChild(btn);
      navButtons.push(btn);
      sections[sec.id] = document.getElementById(sec.id);
    });

    function showSectionSectionId(id) {
      Object.keys(sections).forEach(sid => sections[sid].style.display = (sid === id ? "block" : "none"));
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.section === id));

      if (id === "attendance-section") {
        renderAttendanceTable(); refreshAllPercents(); refreshAllHistoryCells();
        updateClassCountLabel(); updatePresentToday();
      } else if (id === "reports-section") {
        renderReportsTable(); refreshAllPercents(); updateReportsClassesSummary();
      } else if (id === "roster-section") {
        renderRosterTable(); refreshAllPercents();
      } else if (id === "mentor-section") {
        generateMentorReport();
      }
    }

    navButtons.forEach(btn => btn.onclick = () => showSectionSectionId(btn.dataset.section));

    // =========================
    // CLASS RADIOS
    // =========================
    const classRadiosContainer = document.getElementById("class-radios");
    function initClassRadios() {
      classRadiosContainer.innerHTML = "";
      CLASS_CONFIG.forEach(cfg => {
        const id = "cls-" + cfg.key.replace(/\s+/g, "-");
        const label = document.createElement("label");
        label.className = "class-radio-label";
        label.htmlFor = id;

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "class-select";
        input.id = id;
        input.value = cfg.key;

        if (cfg.key === currentClassKey) {
          input.checked = true;
          label.classList.add("active");
        }

        input.addEventListener("change", () => {
          if (!input.checked) return;
          currentClassKey = input.value;
          document.querySelectorAll(".class-radio-label").forEach(l => l.classList.remove("active"));
          label.classList.add("active");

          const today = new Date().toISOString().slice(0, 10);
          if (!currentSession.date) currentSession.date = today;

          attendanceDateInput.value = currentSession.date;
          loadSessionForDate(currentSession.date);

          renderRosterTable(); renderAttendanceTable(); renderReportsTable(); generateMentorReport();
          refreshAllPercents(); refreshAllHistoryCells(); updateReportsClassesSummary();
          saveAll();
        });

        const span = document.createElement("span");
        span.textContent = cfg.label;

        label.appendChild(input);
        label.appendChild(span);
        classRadiosContainer.appendChild(label);
      });
    }

    // =========================
    // ROSTER
    // =========================
    const rollInput = document.getElementById("roll-input");
    const nameInput = document.getElementById("name-input");
    const studentPhoneInput = document.getElementById("student-phone-input");
    const parentPhoneInput = document.getElementById("parent-phone-input");
    const disabledInput = document.getElementById("disabled-input");
    const emailDisplay = document.getElementById("email-display");
    const saveStudentBtn = document.getElementById("save-student-btn");
    const saveStudentLabel = document.getElementById("save-student-label");
    const rosterTbody = document.getElementById("roster-tbody");
    const rosterHeaderCheckbox = document.getElementById("roster-header-checkbox");
    const rosterSelectAllBtn = document.getElementById("roster-select-all-btn");
    const rosterDeleteSelectedBtn = document.getElementById("roster-delete-selected-btn");
    let editingStudentId = null;

    function updateEmailDisplay() {
      const roll = (rollInput.value || "").trim();
      emailDisplay.value = roll ? roll + "@kiit.ac.in" : "";
    }
    rollInput.addEventListener("input", updateEmailDisplay);

    function resetRosterForm() {
      editingStudentId = null;
      rollInput.value = "";
      nameInput.value = "";
      studentPhoneInput.value = "";
      parentPhoneInput.value = "";
      emailDisplay.value = "";
      disabledInput.checked = false;
      saveStudentLabel.textContent = "Add Student";
    }

    function handleSaveStudent() {
      const students = getStudents();
      const roll = (rollInput.value || "").trim();
      const nameRaw = (nameInput.value || "").trim();
      const studentPhone = (studentPhoneInput.value || "").trim();
      const parentPhone = (parentPhoneInput.value || "").trim();
      const disabled = !!disabledInput.checked;

      if (!roll || !nameRaw) { alert("Please enter at least Roll and Name."); return; }

      const name = toTitleCase(nameRaw);
      const email = roll + "@kiit.ac.in";

      if (editingStudentId) {
        const st = students.find(s => s.id === editingStudentId);
        if (st) {
          st.roll = roll;
          st.name = name;
          st.studentPhone = studentPhone;
          st.parentPhone = parentPhone;
          st.email = email;
          st.disabled = disabled;
        }
      } else {
        students.push({
          id: generateId(),
          roll,
          name,
          studentPhone,
          parentPhone,
          email,
          totalSessions: 0,
          presents: 0,
          remarks: [],
          disabled
        });
      }

      resetRosterForm();
      renderRosterTable(); renderAttendanceTable(); renderReportsTable(); generateMentorReport();
      refreshAllPercents(); refreshAllHistoryCells(); updateReportsClassesSummary();
      saveAll();
    }

    saveStudentBtn.addEventListener("click", (e) => { e.preventDefault(); handleSaveStudent(); });

    function startEditStudent(id) {
      const st = findStudentById(id);
      if (!st) return;
      editingStudentId = id;
      rollInput.value = st.roll;
      nameInput.value = st.name;
      studentPhoneInput.value = st.studentPhone || "";
      parentPhoneInput.value = st.parentPhone || "";
      emailDisplay.value = st.email || "";
      disabledInput.checked = !!st.disabled;
      saveStudentLabel.textContent = "Update Student";
      rollInput.focus();
    }

    function deleteStudent(id) {
      const cls = getCurrentClass();
      cls.students = cls.students.filter(s => s.id !== id);
      delete currentSession.marks[id];

      const sessionsByDate = getSessionsByDate();
      Object.keys(sessionsByDate).forEach(date => {
        const sess = sessionsByDate[date];
        if (sess && sess.marks && sess.marks[id]) delete sess.marks[id];
      });

      renderRosterTable(); renderAttendanceTable(); renderReportsTable(); generateMentorReport();
      refreshAllPercents(); refreshAllHistoryCells(); updateReportsClassesSummary();
      saveAll();
    }

    function renderRosterTable() {
      const baseStudents = getStudents();
      rosterTbody.innerHTML = "";
      rosterHeaderCheckbox.checked = false;

      if (baseStudents.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.className = "empty-state";
        td.textContent = "No students added yet. Use the form or import XLS.";
        tr.appendChild(td);
        rosterTbody.appendChild(tr);
        updateClassSummary();
        return;
      }

      const students = baseStudents.slice();
      if (rosterSort.field === "roll") {
        students.sort((a, b) => rosterSort.dir === "asc"
          ? String(a.roll).localeCompare(String(b.roll))
          : String(b.roll).localeCompare(String(a.roll)));
      } else if (rosterSort.field === "name") {
        students.sort((a, b) => rosterSort.dir === "asc"
          ? a.name.localeCompare(b.name)
          : b.name.localeCompare(a.name));
      }

      students.forEach((st, index) => {
        const tr = document.createElement("tr");
        tr.dataset.studentId = st.id;
        if (st.disabled) tr.classList.add("disabled-row");

        const tdSel = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "roster-row-checkbox";
        chk.addEventListener("click", e => e.stopPropagation());
        tdSel.appendChild(chk);

        const tdSno = document.createElement("td"); tdSno.textContent = index + 1;
        const tdRoll = document.createElement("td"); tdRoll.textContent = st.roll;
        const tdName = document.createElement("td"); tdName.textContent = st.name;

        const tdStatus = document.createElement("td");
        tdStatus.textContent = st.disabled ? "DIS" : "";
        tdStatus.style.color = st.disabled ? "#b91c1c" : "";

        const tdSP = document.createElement("td"); tdSP.textContent = st.studentPhone || "-";
        const tdPP = document.createElement("td"); tdPP.textContent = st.parentPhone || "-";
        const tdEmail = document.createElement("td"); tdEmail.textContent = st.email || "-";

        const tdActions = document.createElement("td");
        const wrap = document.createElement("div");
        wrap.className = "table-actions";
        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-sm btn-outline";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => startEditStudent(st.id);

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-sm btn-danger-soft";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => deleteStudent(st.id);

        wrap.append(editBtn, delBtn);
        tdActions.appendChild(wrap);

        tr.append(tdSel, tdSno, tdRoll, tdName, tdStatus, tdSP, tdPP, tdEmail, tdActions);
        rosterTbody.appendChild(tr);
      });

      updateClassSummary();
    }

    rosterHeaderCheckbox.addEventListener("change", () => {
      const checked = rosterHeaderCheckbox.checked;
      document.querySelectorAll("#roster-tbody .roster-row-checkbox").forEach(cb => cb.checked = checked);
    });
    rosterSelectAllBtn.onclick = () => {
      rosterHeaderCheckbox.checked = true;
      rosterHeaderCheckbox.dispatchEvent(new Event("change"));
    };

    rosterDeleteSelectedBtn.onclick = () => {
      const cls = getCurrentClass();
      const idsToDelete = [];
      document.querySelectorAll("#roster-tbody tr").forEach(tr => {
        const cb = tr.querySelector(".roster-row-checkbox");
        if (cb && cb.checked && tr.dataset.studentId) idsToDelete.push(tr.dataset.studentId);
      });
      if (!idsToDelete.length) { alert("No students selected."); return; }
      if (!confirm("Delete " + idsToDelete.length + " selected student(s)?")) return;

      cls.students = cls.students.filter(st => !idsToDelete.includes(st.id));
      idsToDelete.forEach(id => {
        delete currentSession.marks[id];
        const sessionsByDate = getSessionsByDate();
        Object.keys(sessionsByDate).forEach(date => {
          const sess = sessionsByDate[date];
          if (sess && sess.marks && sess.marks[id]) delete sess.marks[id];
        });
      });

      renderRosterTable(); renderAttendanceTable(); renderReportsTable(); generateMentorReport();
      refreshAllPercents(); refreshAllHistoryCells(); updateReportsClassesSummary();
      saveAll();
    };

    document.querySelectorAll("#roster-table thead th.sortable-roster").forEach(th => {
      th.onclick = () => {
        const field = th.dataset.sortField;
        if (!field) return;
        if (rosterSort.field === field) rosterSort.dir = (rosterSort.dir === "asc" ? "desc" : "asc");
        else { rosterSort.field = field; rosterSort.dir = "asc"; }
        renderRosterTable();
      };
    });

    // =========================
    // XLS IMPORT
    // =========================
    const xlsFileInput = document.getElementById("xls-file-input");
    const importXlsBtn = document.getElementById("import-xls-btn");
    const importXlsStatus = document.getElementById("import-xls-status");

    function isHeaderRollCell(val) {
      if (val === null || val === undefined) return true;
      const text = String(val).trim();
      if (!text) return true;
      return text.toLowerCase() === "roll";
    }

    function importStudentsFromWorkbook(workbook) {
      const cls = getCurrentClass();
      const students = cls.students;
      const firstSheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheetName];
      if (!sheet) { importXlsStatus.textContent = "Could not read the first sheet."; return; }

      const range = XLSX.utils.decode_range(sheet["!ref"]);
      let added = 0, updated = 0;

      for (let r = range.s.r; r <= range.e.r; r++) {
        const cellARef = XLSX.utils.encode_cell({ c: 0, r });
        const cellA = sheet[cellARef];
        const rollRaw = cellA ? String(cellA.v).trim() : "";
        if (r === range.s.r && isHeaderRollCell(rollRaw)) continue;
        if (!rollRaw) continue;
        const roll = rollRaw;

        const cellBRef = XLSX.utils.encode_cell({ c: 1, r });
        const cellB = sheet[cellBRef];
        const name = toTitleCase(cellB ? String(cellB.v).trim() : "");

        const cellCRef = XLSX.utils.encode_cell({ c: 2, r });
        const cellC = sheet[cellCRef];
        const studentPhone = cellC ? String(cellC.v).trim() : "";

        const cellERef = XLSX.utils.encode_cell({ c: 4, r });
        const cellE = sheet[cellERef];
        const parentPhone = cellE ? String(cellE.v).trim() : "";

        const email = roll + "@kiit.ac.in";
        const existing = findStudentByRoll(roll);
        if (existing) {
          existing.name = name || existing.name;
          existing.studentPhone = studentPhone || existing.studentPhone;
          existing.parentPhone = parentPhone || existing.parentPhone;
          existing.email = email;
          if (typeof existing.disabled === "undefined") existing.disabled = false;
          updated++;
        } else {
          students.push({
            id: generateId(),
            roll,
            name: name || roll,
            studentPhone,
            parentPhone,
            email,
            totalSessions: 0,
            presents: 0,
            remarks: [],
            disabled: false
          });
          added++;
        }
      }

      renderRosterTable(); renderAttendanceTable(); renderReportsTable(); generateMentorReport();
      refreshAllPercents(); refreshAllHistoryCells(); updateReportsClassesSummary();
      saveAll();
      importXlsStatus.textContent = "Import complete: " + added + " added, " + updated + " updated.";
    }

    importXlsBtn.onclick = () => {
      importXlsStatus.textContent = "";
      const file = xlsFileInput.files && xlsFileInput.files[0];
      if (!file) { alert("Please select an XLS/XLSX file first."); return; }

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          importStudentsFromWorkbook(workbook);
        } catch (err) {
          console.error(err);
          importXlsStatus.textContent = "Error parsing file.";
        } finally {
          xlsFileInput.value = "";
        }
      };
      reader.onerror = () => importXlsStatus.textContent = "Error reading file.";
      reader.readAsArrayBuffer(file);
    };

    // =========================
    // ATTENDANCE
    // =========================
    const attendanceTbody = document.getElementById("attendance-tbody");
    const attendanceDateInput = document.getElementById("attendance-date-input");
    const attendanceNotesInput = document.getElementById("attendance-notes-input");
    const classCountEl = document.getElementById("attendance-class-count");
    const presentTodayEl = document.getElementById("attendance-present-today");
    const saveSessionBtn = document.getElementById("save-session-btn");
    const clearDayBtn = document.getElementById("clear-day-btn");
    const exportExcelBtn = document.getElementById("export-excel-btn");
    const attendanceTableWrapper = document.getElementById("attendance-table-wrapper");
    const toggleAllCheckbox = document.getElementById("toggle-all-checkbox");

    function formatDateDisplay(isoDate) {
      if (!isoDate) return "";
      const [y, m, d] = isoDate.split("-");
      if (!y || !m || !d) return isoDate;
      return d + "-" + m + "-" + y;
    }

    function updateClassCountLabel() {
      const sessionsByDate = getSessionsByDate();
      const selected = attendanceDateInput.value || currentSession.date || "";
      if (!selected) { classCountEl.textContent = ""; return; }

      const dates = Object.keys(sessionsByDate).filter(d => d <= selected).sort();
      const totalClasses = dates.length;
      classCountEl.textContent = totalClasses === 0
        ? "No classes saved on or before this date."
        : "Total classes till this date: " + totalClasses;

      if (sessionsByDate[selected]) {
        clearDayBtn.style.display = "inline-flex";
        attendanceTableWrapper.classList.add("attendance-saved-border");
      } else {
        clearDayBtn.style.display = "none";
        attendanceTableWrapper.classList.remove("attendance-saved-border");
      }
    }

    function updatePresentToday() {
      const students = getStudents();
      if (!students.length) { presentTodayEl.textContent = ""; return; }
      let totalPresent = 0;
      students.forEach(st => {
        const mark = currentSession.marks[st.id];
        if (!st.disabled && mark && mark.present) totalPresent++;
      });
      presentTodayEl.textContent = "Total present today: " + totalPresent + " of " + students.length;
    }

    attendanceDateInput.addEventListener("change", () => loadSessionForDate(attendanceDateInput.value || ""));
    attendanceNotesInput.addEventListener("input", () => { currentSession.notes = attendanceNotesInput.value || ""; });

    function loadSessionForDate(date) {
      const sessionsByDate = getSessionsByDate();
      currentSession = { date, notes: "", marks: {} };
      const saved = sessionsByDate[date];
      if (saved) {
        currentSession.notes = saved.notes || "";
        currentSession.marks = JSON.parse(JSON.stringify(saved.marks || {}));
      }
      attendanceNotesInput.value = currentSession.notes || "";
      renderAttendanceTable(); refreshAllPercents(); refreshAllHistoryCells();
      updateClassCountLabel(); updatePresentToday();
    }

    function renderHistoryCell(st) {
      const history = computeLast3HistoryWithCurrent(st);
      const td = document.createElement("td");
      const pill = document.createElement("div");
      pill.className = "history-pill";
      pill.dataset.historyCell = st.id;

      const dots = (!history.length) ? [null] : Array(3 - history.length).fill(null).concat(history);
      dots.forEach(val => {
        const dot = document.createElement("span");
        if (val === "P") { dot.className = "history-dot history-p"; dot.textContent = "P"; }
        else if (val === "A") { dot.className = "history-dot history-a"; dot.textContent = "A"; }
        else { dot.className = "history-dot history-empty"; dot.textContent = "-"; }
        pill.appendChild(dot);
      });

      td.appendChild(pill);
      return td;
    }

    function renderAttendanceTable() {
      const students = getStudents();
      attendanceTbody.innerHTML = "";
      toggleAllCheckbox.checked = false;

      if (students.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "empty-state";
        td.textContent = "No students in roster for this class.";
        tr.appendChild(td);
        attendanceTbody.appendChild(tr);
        updatePresentToday();
        return;
      }

      students.forEach(st => {
        if (!currentSession.marks[st.id]) currentSession.marks[st.id] = { present: true, remark: "" };
        const mark = currentSession.marks[st.id];
        const percent = computePercentWithPreview(st);

        const tr = document.createElement("tr");
        tr.dataset.studentId = st.id;
        if (!mark.present || st.disabled) tr.classList.add("absent");

        tr.addEventListener("click", e => {
          const t = e.target;
          if (t.tagName === "INPUT" || t.tagName === "TEXTAREA" || t.tagName === "BUTTON") return;
          toggleAttendanceForStudent(st.id);
        });

        const tdHistory = renderHistoryCell(st);
        const tdRoll = document.createElement("td"); tdRoll.textContent = st.roll;

        const tdName = document.createElement("td");
        const span = document.createElement("span");
        span.className = "name-with-percent";
        span.dataset.attName = st.id;
        span.innerHTML = '<span class="name-main">' + st.name + '</span>(' + percent + '%)';
        if (st.disabled) span.classList.add("disabled-text");
        tdName.appendChild(span);

        const tdRemarks = document.createElement("td");
        const inpRem = document.createElement("input");
        inpRem.type = "text";
        inpRem.placeholder = "Add remark";
        inpRem.value = mark.remark || "";
        inpRem.onclick = e => e.stopPropagation();
        inpRem.oninput = () => { currentSession.marks[st.id].remark = inpRem.value; };
        tdRemarks.appendChild(inpRem);

        const tdPres = document.createElement("td");
        tdPres.className = "checkbox-cell";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "checkbox-large";
        chk.checked = !!mark.present && !st.disabled;
        chk.disabled = st.disabled;
        chk.onclick = e => { e.stopPropagation(); if (!st.disabled) setPresentForStudent(st.id, chk.checked); };
        tdPres.appendChild(chk);

        tr.append(tdHistory, tdRoll, tdName, tdRemarks, tdPres);
        attendanceTbody.appendChild(tr);
      });

      updatePresentToday();
    }

    function applyRowState(studentId, isPresent) {
      const row = attendanceTbody.querySelector('tr[data-student-id="' + studentId + '"]');
      if (!row) return;
      const st = findStudentById(studentId);
      const checkbox = row.querySelector("input[type=checkbox]");
      if (checkbox && !st.disabled) checkbox.checked = isPresent;
      if (isPresent && !st.disabled) row.classList.remove("absent"); else row.classList.add("absent");
    }

    function toggleAttendanceForStudent(studentId) {
      const st = findStudentById(studentId);
      if (st && st.disabled) return;
      const mark = currentSession.marks[studentId] || { present: true, remark: "" };
      mark.present = !mark.present;
      currentSession.marks[studentId] = mark;
      applyRowState(studentId, mark.present);
      refreshAllPercents();
      if (st) updateHistoryCellForStudent(st);
      updatePresentToday();
    }

    function setPresentForStudent(studentId, isPresent) {
      const st = findStudentById(studentId);
      if (st && st.disabled) return;
      const mark = currentSession.marks[studentId] || { present: isPresent, remark: "" };
      mark.present = isPresent;
      currentSession.marks[studentId] = mark;
      applyRowState(studentId, isPresent);
      refreshAllPercents();
      if (st) updateHistoryCellForStudent(st);
      updatePresentToday();
    }

    toggleAllCheckbox.addEventListener("change", () => {
      const check = toggleAllCheckbox.checked;
      getStudents().forEach(st => {
        if (st.disabled) return;
        if (!currentSession.marks[st.id]) currentSession.marks[st.id] = { present: check, remark: "" };
        else currentSession.marks[st.id].present = check;
        applyRowState(st.id, check);
        updateHistoryCellForStudent(st);
      });
      refreshAllPercents();
      updatePresentToday();
    });

    function splitName(fullName) {
      const parts = (fullName || "").trim().split(/\s+/).filter(Boolean);
      if (parts.length === 0) return { first: "", last: "" };
      if (parts.length === 1) return { first: parts[0], last: "" };
      return { first: parts[0], last: parts.slice(1).join(" ") };
    }

    function exportAttendanceExcelForCurrentDate() {
      const cls = getCurrentClass();
      const students = cls.students;
      if (!students || students.length === 0) { alert("No students in roster for this class."); return; }

      const date = attendanceDateInput.value || currentSession.date;
      if (!date) { alert("Please select a date first."); return; }

      const sessionsByDate = cls.sessionsByDate || {};
      const savedSession = sessionsByDate[date];

      if (!savedSession && (!currentSession.marks || Object.keys(currentSession.marks).length === 0)) {
        alert("No attendance data for this date.");
        return;
      }

      const marksSource = savedSession ? savedSession.marks : currentSession.marks;

      const rows = [];
      rows.push(["Roll No.", "First Name", "Last Name", "Attendance"]);

      students.forEach(st => {
        const m = marksSource[st.id] || { present: true };
        const att = (!st.disabled && m.present) ? "P" : "A";
        const { first, last } = splitName(st.name || "");
        rows.push([st.roll, first, last, att]);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Attendance");

      const dParts = date.split("-");
      let ddmm = date;
      if (dParts.length === 3) ddmm = dParts[2] + dParts[1];

      const meta = getCurrentClassMeta();
      const code = meta ? meta.classCode : currentClassKey.replace(/\s+/g, "");
      const sap = meta ? meta.sapKey : "SAP";
      const filename = code + "_" + ddmm + "_" + sap + ".xls";

      XLSX.writeFile(wb, filename, { bookType: "xls" });
    }
    exportExcelBtn.onclick = e => { e.preventDefault(); exportAttendanceExcelForCurrentDate(); };

    function saveAttendanceSession() {
      const students = getStudents();
      if (students.length === 0) { alert("No students to save. Add students in the Roster tab first."); return; }
      if (!currentSession.date) { alert("Please select a date for this session."); return; }

      const cls = getCurrentClass();
      const sessionsByDate = cls.sessionsByDate;
      const prev = sessionsByDate[currentSession.date];

      if (prev && prev.marks) {
        students.forEach(st => {
          const oldMark = prev.marks[st.id];
          if (!oldMark) return;
          if (st.totalSessions > 0) st.totalSessions -= 1;
          if (!st.disabled && oldMark.present && st.presents > 0) st.presents -= 1;
        });
      }

      sessionsByDate[currentSession.date] = {
        notes: currentSession.notes || "",
        marks: JSON.parse(JSON.stringify(currentSession.marks))
      };

      students.forEach(st => {
        let mark = currentSession.marks[st.id];
        if (!mark) { mark = { present: true, remark: "" }; currentSession.marks[st.id] = mark; }

        st.totalSessions = (st.totalSessions || 0) + 1;
        if (!st.disabled && mark.present) st.presents = (st.presents || 0) + 1;

        const remarkText = (mark.remark || "").trim();
        if (remarkText) st.remarks.push({ date: currentSession.date, text: remarkText });
      });

      Object.keys(currentSession.marks).forEach(id => currentSession.marks[id].remark = "");
      attendanceNotesInput.value = "";
      currentSession.notes = "";

      renderAttendanceTable(); renderReportsTable(); generateMentorReport();
      refreshAllPercents(); refreshAllHistoryCells();
      updateClassCountLabel(); updatePresentToday(); updateReportsClassesSummary();
      saveAll();

      alert("Attendance saved successfully for " + formatDateDisplay(currentSession.date) + ".");
      showSectionSectionId("reports-section");
    }
    saveSessionBtn.onclick = e => { e.preventDefault(); saveAttendanceSession(); };

    function clearAttendanceForCurrentDate() {
      const date = currentSession.date;
      if (!date) { alert("Select a date first."); return; }

      const cls = getCurrentClass();
      const sessionsByDate = cls.sessionsByDate;
      const session = sessionsByDate[date];

      if (!session) {
        currentSession = { date, notes: "", marks: {} };
        attendanceNotesInput.value = "";
        renderAttendanceTable(); refreshAllPercents(); refreshAllHistoryCells();
        updateClassCountLabel(); updatePresentToday(); updateReportsClassesSummary();
        saveAll();
        return;
      }

      if (!confirm("This will remove saved attendance for " + formatDateDisplay(date) + " and adjust totals. Continue?")) return;

      getStudents().forEach(st => {
        const mark = session.marks[st.id];
        if (!mark) return;
        if (st.totalSessions > 0) st.totalSessions -= 1;
        if (!st.disabled && mark.present && st.presents > 0) st.presents -= 1;
      });

      delete sessionsByDate[date];

      currentSession = { date, notes: "", marks: {} };
      attendanceNotesInput.value = "";
      renderAttendanceTable(); renderReportsTable(); generateMentorReport();
      refreshAllPercents(); refreshAllHistoryCells();
      updateClassCountLabel(); updatePresentToday(); updateReportsClassesSummary();
      saveAll();
    }
    clearDayBtn.ondblclick = e => { e.preventDefault(); clearAttendanceForCurrentDate(); };

    // =========================
    // REPORTS (Msgs)
    // =========================
    const reportsTbody = document.getElementById("reports-tbody");
    const reportsHeaderRow = document.getElementById("reports-header-row");
    const reportsActionSelect = document.getElementById("reports-action-select");

    function makeAttBadge(type, text) {
      const span = document.createElement("span");
      span.className = "att-badge " + (type === "A" ? "att-badge-a" : "att-badge-p");
      span.textContent = text;
      return span;
    }

    function renderReportsTable() {
      const cls = getCurrentClass();
      const students = cls.students.slice();
      const sessionsByDate = cls.sessionsByDate || {};
      const dates = Object.keys(sessionsByDate).sort();

      reportsHeaderRow.innerHTML = "";

      function mkTh(text, sortableField, width) {
        const th = document.createElement("th");
        if (width) th.style.width = width;
        if (text) th.textContent = text;
        if (sortableField) { th.className = "sortable"; th.dataset.sortField = sortableField; }
        return th;
      }

      // Column order: S.No, Roll, Action, %, Name, Dates..., Tot P, Tot A, #Remarks
      reportsHeaderRow.appendChild(mkTh("S.No", "sno", "50px"));
      reportsHeaderRow.appendChild(mkTh("Roll", "roll", "90px"));
      reportsHeaderRow.appendChild(mkTh("Action", null, "100px"));
      reportsHeaderRow.appendChild(mkTh("%", "percent", "70px"));
      reportsHeaderRow.appendChild(mkTh("Name", "name"));

      dates.forEach(d => {
        const th = document.createElement("th");
        th.textContent = formatDateDisplay(d);
        th.title = "Attendance on " + formatDateDisplay(d) + " (Absence count / Present count)";
        reportsHeaderRow.appendChild(th);
      });

      reportsHeaderRow.appendChild(mkTh("Total P", null, "60px"));
      reportsHeaderRow.appendChild(mkTh("Total A", null, "60px"));
      reportsHeaderRow.appendChild(mkTh("#Remarks", "remarksCount", "80px"));

      students.sort((a, b) => {
        if (reportSort.field === "roll") {
          return reportSort.dir === "asc"
            ? String(a.roll).localeCompare(String(b.roll))
            : String(b.roll).localeCompare(String(a.roll));
        }
        if (reportSort.field === "name") {
          return reportSort.dir === "asc"
            ? a.name.localeCompare(b.name)
            : b.name.localeCompare(a.name);
        }
        if (reportSort.field === "percent") {
          const ta = a.totalSessions || 0;
          const pa = a.disabled ? 0 : (a.presents || 0);
          const tb = b.totalSessions || 0;
          const pb = b.disabled ? 0 : (b.presents || 0);
          const paPct = ta ? Math.round(100 * pa / ta) : 0;
          const pbPct = tb ? Math.round(100 * pb / tb) : 0;
          return reportSort.dir === "asc" ? paPct - pbPct : pbPct - paPct;
        }
        if (reportSort.field === "remarksCount") {
          const ra = (a.remarks || []).length;
          const rb = (b.remarks || []).length;
          return reportSort.dir === "asc" ? ra - rb : rb - ra;
        }
        return 0;
      });

      reportsTbody.innerHTML = "";
      if (students.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5 + dates.length + 3;
        td.className = "empty-state";
        td.textContent = "No students in roster.";
        tr.appendChild(td);
        reportsTbody.appendChild(tr);
        return;
      }

      students.forEach((st, index) => {
        const tr = document.createElement("tr");
        tr.dataset.studentId = st.id;
        if (st.disabled) tr.classList.add("disabled-row");

        const totalSess = st.totalSessions || 0;
        const totalP = st.disabled ? 0 : (st.presents || 0);
        const totalA = totalSess - totalP;
        const percent = totalSess === 0 ? 0 : Math.round(100 * totalP / totalSess);

        const tdSno = document.createElement("td"); tdSno.textContent = index + 1;
        const tdRoll = document.createElement("td"); tdRoll.textContent = st.roll;

        const tdActions = document.createElement("td");
        const actionBtn = document.createElement("button");
        actionBtn.className = "btn btn-sm btn-outline";
        actionBtn.textContent = "Run";
        actionBtn.onclick = () => {
          const action = reportsActionSelect.value;
          if (action === "wa-student" || action === "wa-parent") {
            sendWhatsAppToStudent(st.id, action === "wa-parent" ? "parent" : "student");
          } else if (action === "email-student") {
            sendEmailToStudent(st.id);
          } else if (action === "email-parent-cc-student") {
            sendEmailToParentCcStudent(st.id);
          }
        };
        tdActions.appendChild(actionBtn);

        const tdPercent = document.createElement("td");
        tdPercent.className = "percent-cell";
        tdPercent.dataset.percentCellReport = st.id;
        tdPercent.textContent = percent + "%";

        const tdName = document.createElement("td"); tdName.textContent = st.name;

        tr.append(tdSno, tdRoll, tdActions, tdPercent, tdName);

        // Per-student running counters:
        // - Present => green badge with runningP (1..N)
        // - Absent  => red badge with runningA (1..N)   (as requested)
        let runningP = 0;
        let runningA = 0;

        dates.forEach(d => {
          const sess = sessionsByDate[d];
          const mark = sess && sess.marks && sess.marks[st.id];
          const td = document.createElement("td");

          if (mark) {
            const isPresent = (!st.disabled && mark.present);
            if (isPresent) {
              runningP += 1;
              td.appendChild(makeAttBadge("P", String(runningP)));
            } else {
              runningA += 1;
              td.appendChild(makeAttBadge("A", String(runningA)));
            }
          } else {
            td.textContent = "";
          }

          tr.appendChild(td);
        });

        const tdTotP = document.createElement("td"); tdTotP.textContent = totalP;
        const tdTotA = document.createElement("td"); tdTotA.textContent = totalA;

        const tdRemarksCount = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = (st.remarks || []).length;
        tdRemarksCount.appendChild(badge);
        tdRemarksCount.style.cursor = "pointer";
        tdRemarksCount.onclick = () => openRemarksModal(st.id);

        tr.append(tdTotP, tdTotA, tdRemarksCount);
        reportsTbody.appendChild(tr);
      });

      updateClassSummary();

      document.querySelectorAll("#reports-table thead th.sortable").forEach(th => {
        th.onclick = () => {
          const field = th.dataset.sortField;
          if (!field) return;
          if (reportSort.field === field) reportSort.dir = (reportSort.dir === "asc" ? "desc" : "asc");
          else { reportSort.field = field; reportSort.dir = "asc"; }
          renderReportsTable();
        };
      });
    }

    function updateReportsClassesSummary() {
      const summaryEl = document.getElementById("reports-classes-summary");
      const sessionsByDate = getSessionsByDate();
      const allDates = Object.keys(sessionsByDate);

      if (!allDates.length) { summaryEl.textContent = "No classes have been saved yet."; return; }

      const today = new Date().toISOString().slice(0, 10);
      const countTillToday = allDates.filter(d => d <= today).length;
      summaryEl.textContent = "Total number of classes till today: " + countTillToday;
    }

    // =========================
    // WhatsApp + Email
    // =========================
    function sendWhatsAppToStudent(studentId, to = "student") {
      const st = findStudentById(studentId);
      if (!st) return;

      const phone = (to === "parent") ? (st.parentPhone || "").trim() : (st.studentPhone || "").trim();
      if (!phone) { alert((to === "parent" ? "Parent" : "Student") + " phone number is missing."); return; }

      const totalSessions = st.totalSessions || 0;
      const presents = st.disabled ? 0 : (st.presents || 0);
      const percent = totalSessions ? Math.round(100 * presents / totalSessions) : 0;

      const remarksSummary = (!st.remarks || st.remarks.length === 0)
        ? "None"
        : st.remarks.slice(-3).map(r => r.text).join("; ");

      const meta = getCurrentClassMeta();
      const className = meta ? meta.label : currentClassKey;

      const template = (to === "parent") ? appSettings.whatsappParentTemplate : appSettings.whatsappStudentTemplate;
      const message = template
        .replace("{name}", st.name)
        .replace("{roll}", st.roll)
        .replace("{percent}", percent)
        .replace("{remarks}", remarksSummary)
        .replace("{class name}", className)
        .replace("{total number of classes}", totalSessions)
        .replace("{Classes you are present}", presents);

      const url = WHATSAPP_CONFIG.apiBase
        + "?number=" + encodeURIComponent(phone)
        + "&type=text"
        + "&message=" + encodeURIComponent(message)
        + "&instance_id=" + encodeURIComponent(WHATSAPP_CONFIG.instanceId)
        + "&access_token=" + encodeURIComponent(WHATSAPP_CONFIG.accessToken);

      window.open(url, "_blank");
    }

    function buildEmailBodyFromTemplate(template, st, extraRemarks) {
      const totalSessions = st.totalSessions || 0;
      const presents = st.disabled ? 0 : (st.presents || 0);
      const percent = totalSessions ? Math.round(100 * presents / totalSessions) : 0;
      const remarksSummary = extraRemarks || ((!st.remarks || st.remarks.length === 0)
        ? "None"
        : st.remarks.slice(-3).map(r => r.text).join("; "));
      const meta = getCurrentClassMeta();
      const className = meta ? meta.label : currentClassKey;

      return template
        .replace("{name}", st.name)
        .replace("{roll}", st.roll)
        .replace("{percent}", percent)
        .replace("{remarks}", remarksSummary)
        .replace("{class name}", className)
        .replace("{total number of classes}", totalSessions)
        .replace("{Classes you are present}", presents);
    }

    function sendEmailToStudent(studentId) {
      const st = findStudentById(studentId);
      if (!st || !st.email) {
        alert("Student email missing for this record.");
        return;
      }
      const subject = "Attendance update - " + st.roll;
      const body = buildEmailBodyFromTemplate(appSettings.studentEmailTemplate, st);
      const url = "mailto:" + encodeURIComponent(st.email)
        + "?subject=" + encodeURIComponent(subject)
        + "&body=" + encodeURIComponent(body);
      window.location.href = url;
    }

    function sendEmailToParentCcStudent(studentId) {
      const st = findStudentById(studentId);
      if (!st) return;

      const parentEmail = st.parentEmail || "";
      if (!parentEmail) {
        alert("Parent email not configured for this student.");
        return;
      }
      if (!st.email) {
        alert("Student email missing for cc.");
        return;
      }

      const subject = "Attendance update - " + st.roll;
      const body = buildEmailBodyFromTemplate(appSettings.parentEmailTemplate, st);
      const url = "mailto:" + encodeURIComponent(parentEmail)
        + "?cc=" + encodeURIComponent(st.email)
        + "&subject=" + encodeURIComponent(subject)
        + "&body=" + encodeURIComponent(body);

      window.location.href = url;
    }

    // =========================
    // Percent refresh
    // =========================
    function refreshAllPercents() {
      getStudents().forEach(st => {
        const percent = computePercentWithPreview(st);
        const el = document.querySelector('[data-att-name="' + st.id + '"]');
        if (el) el.innerHTML = '<span class="name-main">' + st.name + '</span>(' + percent + '%)';
      });

      getStudents().forEach(st => {
        const totalSess = st.totalSessions || 0;
        const p = st.disabled ? 0 : (st.presents || 0);
        const percent = totalSess === 0 ? 0 : Math.round(100 * p / totalSess);
        const el = document.querySelector('[data-percent-cell-report="' + st.id + '"]');
        if (el) el.textContent = percent + "%";
      });
    }

    // =========================
    // Remarks modal
    // =========================
    const remarksModalBackdrop = document.getElementById("remarks-modal-backdrop");
    const remarksModalMeta = document.getElementById("remarks-modal-meta");
    const remarksModalList = document.getElementById("remarks-modal-list");
    const remarksModalEmpty = document.getElementById("remarks-modal-empty");
    const closeRemarksModalBtn = document.getElementById("close-remarks-modal-btn");
    const remarksModalOkBtn = document.getElementById("remarks-modal-ok-btn");
    const remarksModalTitle = document.getElementById("remarks-modal-title");

    function openRemarksModal(studentId) {
      const st = findStudentById(studentId);
      if (!st) return;

      remarksModalTitle.textContent = "Remarks for " + st.name + " (" + st.roll + ")";
      remarksModalMeta.textContent = "Total remarks: " + (st.remarks || []).length;
      remarksModalList.innerHTML = "";

      const list = st.remarks || [];
      if (!list.length) {
        remarksModalEmpty.style.display = "block";
      } else {
        remarksModalEmpty.style.display = "none";
        list.forEach(r => {
          const li = document.createElement("li");
          const d = document.createElement("div");
          d.className = "remarks-date";
          d.textContent = r.date ? formatDateDisplay(r.date) : "(no date)";
          const t = document.createElement("div");
          t.className = "remarks-text";
          t.textContent = r.text || "";
          li.append(d, t);
          remarksModalList.appendChild(li);
        });
      }

      remarksModalBackdrop.style.display = "flex";
      remarksModalBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeRemarksModal() {
      remarksModalBackdrop.style.display = "none";
      remarksModalBackdrop.setAttribute("aria-hidden", "true");
    }
    closeRemarksModalBtn.onclick = closeRemarksModal;
    remarksModalOkBtn.onclick = closeRemarksModal;
    remarksModalBackdrop.onclick = e => { if (e.target === remarksModalBackdrop) closeRemarksModal(); };

    // =========================
    // Settings modal
    // =========================
    const settingsBtn = document.getElementById("settings-btn");
    const settingsModalBackdrop = document.getElementById("settings-modal-backdrop");
    const closeSettingsModalBtn = document.getElementById("close-settings-modal-btn");
    const settingsCancelBtn = document.getElementById("settings-cancel-btn");
    const settingsSaveBtn = document.getElementById("settings-save-btn");
    const settingsWaStudentTextarea = document.getElementById("settings-wa-student-template");
    const settingsWaParentTextarea = document.getElementById("settings-wa-parent-template");
    const settingsStudentEmailTextarea = document.getElementById("settings-student-email-template");
    const settingsParentEmailTextarea = document.getElementById("settings-parent-email-template");

    function openSettingsModal() {
      settingsWaStudentTextarea.value = appSettings.whatsappStudentTemplate || TEMPLATE_CONFIG_DEFAULTS.whatsappStudentTemplate;
      settingsWaParentTextarea.value = appSettings.whatsappParentTemplate || TEMPLATE_CONFIG_DEFAULTS.whatsappParentTemplate;
      settingsStudentEmailTextarea.value = appSettings.studentEmailTemplate || TEMPLATE_CONFIG_DEFAULTS.studentEmailTemplate;
      settingsParentEmailTextarea.value = appSettings.parentEmailTemplate || TEMPLATE_CONFIG_DEFAULTS.parentEmailTemplate;

      settingsModalBackdrop.style.display = "flex";
      settingsModalBackdrop.setAttribute("aria-hidden", "false");
    }
    function closeSettingsModal() {
      settingsModalBackdrop.style.display = "none";
      settingsModalBackdrop.setAttribute("aria-hidden", "true");
    }
    settingsBtn.onclick = openSettingsModal;
    closeSettingsModalBtn.onclick = closeSettingsModal;
    settingsCancelBtn.onclick = closeSettingsModal;
    settingsModalBackdrop.onclick = e => { if (e.target === settingsModalBackdrop) closeSettingsModal(); };

    settingsSaveBtn.onclick = () => {
      appSettings.whatsappStudentTemplate = settingsWaStudentTextarea.value || TEMPLATE_CONFIG_DEFAULTS.whatsappStudentTemplate;
      appSettings.whatsappParentTemplate  = settingsWaParentTextarea.value  || TEMPLATE_CONFIG_DEFAULTS.whatsappParentTemplate;
      appSettings.studentEmailTemplate    = settingsStudentEmailTextarea.value || TEMPLATE_CONFIG_DEFAULTS.studentEmailTemplate;
      appSettings.parentEmailTemplate     = settingsParentEmailTextarea.value  || TEMPLATE_CONFIG_DEFAULTS.parentEmailTemplate;

      saveAll();
      closeSettingsModal();
    };

    // =========================
    // Backup/Restore/Export
    // =========================
    const backupBtn = document.getElementById("backup-btn");
    const restoreBtn = document.getElementById("restore-btn");
    const restoreFileInput = document.getElementById("restore-file-input");
    const exportClassExcelBtn = document.getElementById("export-class-excel-btn");

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    backupBtn.onclick = () => {
      const json = JSON.stringify(buildAppDataObject(), null, 2);
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      downloadTextFile("K_Att_BU_" + dd + "-" + mm + "-" + yyyy + ".json", json);
    };

    restoreBtn.onclick = () => restoreFileInput.click();

    restoreFileInput.onchange = () => {
      const file = restoreFileInput.files && restoreFileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (!parsed || !parsed.classes) { alert("Invalid backup file."); return; }
          applyLoadedData(parsed);

          initClassRadios();

          const today = new Date().toISOString().slice(0, 10);
          currentSession = { date: today, notes: "", marks: {} };
          attendanceDateInput.value = today;
          loadSessionForDate(today);

          renderRosterTable(); renderAttendanceTable(); renderReportsTable(); generateMentorReport();
          refreshAllPercents(); refreshAllHistoryCells(); updateReportsClassesSummary();

          alert("Data restored successfully.");
          saveAll();
        } catch (err) {
          console.error(err);
          alert("Error reading backup file.");
        } finally {
          restoreFileInput.value = "";
        }
      };
      reader.readAsText(file);
    };

    function exportFullClassExcel() {
      const cls = getCurrentClass();
      const students = cls.students;
      const sessionsByDate = cls.sessionsByDate || {};
      const meta = getCurrentClassMeta();
      const classCode = meta ? meta.classCode : currentClassKey.replace(/\s+/g, "_");
      const className = meta ? meta.label : currentClassKey;

      if (!students || students.length === 0) { alert("No students in roster for this class."); return; }

      const sessionDates = Object.keys(sessionsByDate).sort();
      if (sessionDates.length === 0) { alert("No saved attendance sessions for this class."); return; }

      const rows = [];
      const header = ["Roll", "Name"];
      sessionDates.forEach(d => header.push(formatDateDisplay(d)));
      header.push("Total P", "Total A", "%");
      rows.push(header);

      students.forEach(st => {
        let totalSessions = 0;
        let presents = 0;
        const row = [st.roll, st.name];

        sessionDates.forEach(d => {
          const sess = sessionsByDate[d];
          const mark = sess && sess.marks && sess.marks[st.id];
          if (mark) {
            totalSessions += 1;
            if (!st.disabled && mark.present) { presents += 1; row.push("P"); }
            else row.push("A");
          } else {
            row.push("");
          }
        });

        const absents = totalSessions - presents;
        const percent = totalSessions === 0 ? 0 : Math.round(100 * presents / totalSessions);
        row.push(presents, absents, percent + "%");
        rows.push(row);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Class Attendance");

      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      XLSX.writeFile(wb, classCode + "_" + className.replace(/\s+/g, "_") + "_" + dd + "-" + mm + "-" + yyyy + ".xlsx");
    }
    exportClassExcelBtn.onclick = exportFullClassExcel;

    // =========================
    // Mentor report
    // =========================
    const mentorSummaryEl = document.getElementById("mentor-summary");
    const mentorTableContainer = document.getElementById("mentor-table-container");
    const mentorTbody = document.getElementById("mentor-tbody");
    const mentorTypeRadios = document.getElementsByName("mentor-report-type");
    const generateMentorReportBtn = document.getElementById("generate-mentor-report-btn");
    const exportMentorReportBtn = document.getElementById("export-mentor-report-btn");
    const mentorCopyWaBtn = document.getElementById("mentor-copy-wa-btn");

    const mentorConsecutiveInput = document.getElementById("mentor-consecutive-input");
    const mentorPercentInput = document.getElementById("mentor-percent-input");

    function getSelectedMentorType() {
      for (let i = 0; i < mentorTypeRadios.length; i++) if (mentorTypeRadios[i].checked) return mentorTypeRadios[i].value;
      return "consecutive";
    }

    function syncMentorInlineInputs() {
      const t = getSelectedMentorType();
      if (t === "consecutive") {
        mentorConsecutiveInput.disabled = false;
        mentorPercentInput.disabled = true;
      } else {
        mentorConsecutiveInput.disabled = true;
        mentorPercentInput.disabled = false;
      }
    }

    Array.from(mentorTypeRadios).forEach(r => r.addEventListener("change", () => {
      syncMentorInlineInputs();
      generateMentorReport();
    }));
    mentorConsecutiveInput.addEventListener("input", () => { if (!mentorConsecutiveInput.disabled) generateMentorReport(); });
    mentorPercentInput.addEventListener("input", () => { if (!mentorPercentInput.disabled) generateMentorReport(); });

    function computeConsecutiveAbsencesFromEnd(student, sessionsByDate) {
      const dates = Object.keys(sessionsByDate).sort();
      let count = 0;
      for (let i = dates.length - 1; i >= 0; i--) {
        const d = dates[i];
        const sess = sessionsByDate[d];
        const mark = sess.marks && sess.marks[student.id];
        if (!mark) break;
        if (!student.disabled && mark.present) break;
        if (student.disabled || !mark.present) count++;
      }
      return count;
    }

    function stripBracketPart(text) { return (text || "").replace(/\(.*?\)/g, "").trim(); }

    function sortMentorFiltered(filtered) {
      const dir = mentorSort.dir === "asc" ? 1 : -1;
      const field = mentorSort.field;
      const asText = v => String(v ?? "").toLowerCase();
      const asNum = v => Number(v ?? 0);

      filtered.sort((x, y) => {
        if (field === "roll")     return dir * asText(x.student.roll).localeCompare(asText(y.student.roll));
        if (field === "name")     return dir * asText(x.student.name).localeCompare(asText(y.student.name));
        if (field === "detail")   return dir * asText(x.detail).localeCompare(asText(y.detail));
        if (field === "attendance" || field === "percent")
          return dir * (asNum(x.percent) - asNum(y.percent));
        if (field === "total")    return dir * (asNum(x.total) - asNum(y.total));
        if (field === "p")        return dir * (asNum(x.p) - asNum(y.p));
        if (field === "a")        return dir * (asNum(x.a) - asNum(y.a));
        return dir * asText(x.student.roll).localeCompare(asText(y.student.roll));
      });
    }

    function generateMentorReport() {
      const cls = getCurrentClass();
      const students = cls.students || [];
      const sessionsByDate = cls.sessionsByDate || {};
      const sessionDates = Object.keys(sessionsByDate).sort();

      if (students.length === 0) { mentorSummaryEl.textContent = "No students in roster."; mentorTableContainer.style.display = "none"; lastMentorReport = []; return; }
      if (sessionDates.length === 0) { mentorSummaryEl.textContent = "No saved attendance sessions available."; mentorTableContainer.style.display = "none"; lastMentorReport = []; return; }

      const type = getSelectedMentorType();
      let filtered = [];

      if (type === "consecutive") {
        const x = parseInt(mentorConsecutiveInput.value, 10) || 1;
        students.forEach(st => {
          const consecA = computeConsecutiveAbsencesFromEnd(st, sessionsByDate);
          if (consecA >= x) {
            const total = st.totalSessions || 0;
            const p = st.disabled ? 0 : (st.presents || 0);
            const a = total - p;
            const percent = total === 0 ? 0 : Math.round(100 * p / total);
            filtered.push({ student: st, total, p, a, percent, detail: "Absent " + consecA + " classes consecutively" });
          }
        });
        mentorSummaryEl.textContent = (x === 1)
          ? "Report: Today's Absent list. Found " + filtered.length + " students."
          : "Report: Students absent for at least " + x + " consecutive classes. Found " + filtered.length + " students.";
      } else {
        const thr = parseInt(mentorPercentInput.value, 10) || 0;
        students.forEach(st => {
          const total = st.totalSessions || 0;
          const p = st.disabled ? 0 : (st.presents || 0);
          const a = total - p;
          const percent = total === 0 ? 0 : Math.round(100 * p / total);
          if (percent < thr) filtered.push({ student: st, total, p, a, percent, detail: "Attendance " + percent + "% < " + thr + "%" });
        });
        mentorSummaryEl.textContent = "Report: Students whose attendance is less than " + thr + "%. Found " + filtered.length + " students.";
      }

      mentorTbody.innerHTML = "";
      if (filtered.length === 0) { mentorTableContainer.style.display = "none"; lastMentorReport = []; return; }

      mentorTableContainer.style.display = "block";
      sortMentorFiltered(filtered);

      lastMentorReport = filtered.slice(); // store in display order

      filtered.forEach((item, idx) => {
        const tr = document.createElement("tr");

        const attendanceText = item.total
          ? (item.p + "/" + item.total + " (" + item.percent + "%)")
          : "0/0 (0%)";

        tr.innerHTML =
          "<td>" + (idx + 1) + "</td>" +
          "<td>" + item.student.roll + "</td>" +
          "<td>" + item.student.name + "</td>" +
          "<td>" + attendanceText + "</td>" +
          "<td>" + stripBracketPart(item.detail) + "</td>";

        if (item.student.disabled) tr.classList.add("disabled-row");

        mentorTbody.appendChild(tr);
      });
    }

    generateMentorReportBtn.onclick = generateMentorReport;

    document.querySelectorAll("#mentor-table thead th.sortable-mentor").forEach(th => {
      th.onclick = () => {
        const field = th.dataset.sortField;
        if (!field) return;
        if (mentorSort.field === field) mentorSort.dir = (mentorSort.dir === "asc" ? "desc" : "asc");
        else { mentorSort.field = field; mentorSort.dir = "asc"; }
        generateMentorReport();
      };
    });

    function exportMentorReportExcel() {
      if (!lastMentorReport || lastMentorReport.length === 0) { alert("No mentor report data to export."); return; }
      const meta = getCurrentClassMeta();
      const classCode = meta ? meta.classCode : currentClassKey.replace(/\s+/g, "_");
      const className = meta ? meta.label : currentClassKey;

      const rows = [["Roll", "Name", "Attendance", "Details"]];
      lastMentorReport.forEach(item => {
        const attendanceText = item.total
          ? (item.p + "/" + item.total + " (" + item.percent + "%)")
          : "0/0 (0%)";
        rows.push([
          item.student.roll,
          item.student.name,
          attendanceText,
          stripBracketPart(item.detail)
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Mentor Report");

      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      XLSX.writeFile(wb, "Mentor_Report_" + classCode + "_" + className.replace(/\s+/g, "_") + "_" + dd + "-" + mm + "-" + yyyy + ".xlsx");
    }
    exportMentorReportBtn.onclick = exportMentorReportExcel;

    function getMentorSortLabel() {
      const f = (mentorSort && mentorSort.field) ? mentorSort.field : "roll";
      const dir = (mentorSort && mentorSort.dir) ? mentorSort.dir : "asc";

      // Your mentor table uses data-sort-field="roll" and "attendance"
      // and your sortMentorFiltered treats "attendance" and "percent" as the same
      if (f === "roll") return "Sorted by Roll";
      if (f === "attendance" || f === "percent") return "Sorted by Attendance %";
      if (f === "name") return "Sorted by Name (" + dir + ")";
      if (f === "detail") return "Sorted by Details (" + dir + ")";
      if (f === "total") return "Sorted by Total (" + dir + ")";
      if (f === "p") return "Sorted by Present (" + dir + ")";
      if (f === "a") return "Sorted by Absent (" + dir + ")";
      return "Sorted by " + f + " (" + dir + ")";
    }


    function buildMentorWhatsappText() {
      if (!lastMentorReport || lastMentorReport.length === 0) {
        return "No mentor report data available.";
      }
      const meta = getCurrentClassMeta();
      const className = meta ? meta.label : currentClassKey;
      const type = getSelectedMentorType();

      let header = className + " - Mentor Report\n";

      if (type === "consecutive") {
        const x = parseInt(mentorConsecutiveInput.value, 10) || 1;
        if (x === 1) {
          header += "Today's Absent list\n\n(" + getMentorSortLabel() + ")";
        } else {
          header += "Absent at least " + x + " consecutively\n\n(" + getMentorSortLabel() + ")";
        }
      } else {
        const thr = parseInt(mentorPercentInput.value, 10) || 0;
        header += "*Criteria:* Attendance less than " + thr + "%\n\n(" + getMentorSortLabel() + ")";
      }

      header += "\n";



      const NAME_LENGTH = 10; // Change this number to adjust name width

      const lines = lastMentorReport.map((item, idx) => {
        const st = item.student;
        const total = item.total || 0;
        const p = item.p || 0;
        const percent = item.percent || 0;


        // 1. Get the first word
        let rawName = ((st.name || "").trim().split(/\s+/)[0] || "");

        // 2. Apply Length Logic using the variable
        // Cut if too long, add spaces if too short
        const firstWord = rawName.slice(0, NAME_LENGTH).padEnd(NAME_LENGTH, " "); 


        const formattedP = String(p).padStart(2, '0');

        return (
          (idx + 1) + ". " +
          st.roll + " ```" + firstWord + "  ```" +
          formattedP + " (" + percent + "%)"
        );
      });

      const body = lines.join("\n");
      const total = (lastMentorReport[0]?.total) || 0;
      const footer = "\n\n_Total Classes: " + total +"_ (100%)";

      return header + body + footer;
    }

    async function copyMentorWhatsappTextToClipboard() {
      const text = buildMentorWhatsappText();
      try {
        await navigator.clipboard.writeText(text);
      } catch (e) {
        console.error("Clipboard error:", e);
      }

      if (!mentorCopyWaBtn) return;
      const originalClass = mentorCopyWaBtn.className;
      mentorCopyWaBtn.className = originalClass + " btn-primary";
      setTimeout(() => {
        mentorCopyWaBtn.className = originalClass;
      }, 3000);
    }

    mentorCopyWaBtn.onclick = copyMentorWhatsappTextToClipboard;

    // =========================
    // INIT
    // =========================
    (async function init() {
      await runServerDiagnostics();

      let hadStored = await loadFromServer();
      if (!hadStored) hadStored = loadFromLocalStorage();
      if (!hadStored) ensureClass(currentClassKey);

      initClassRadios();

      const today = new Date().toISOString().slice(0, 10);
      if (!currentSession.date) currentSession.date = today;
      attendanceDateInput.value = currentSession.date;
      loadSessionForDate(currentSession.date);

      syncMentorInlineInputs();

      renderRosterTable();
      renderAttendanceTable();
      renderReportsTable();
      generateMentorReport();
      refreshAllPercents();
      refreshAllHistoryCells();
      updateClassSummary();
      updateClassCountLabel();
      updatePresentToday();
      updateReportsClassesSummary();

      showSectionSectionId("reports-section");
    })();
  </script>
</body>
</html>
