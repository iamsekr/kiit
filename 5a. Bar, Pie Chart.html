<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Analytics Dashboard</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --accent: #38bdf8;
            --text: #e2e8f0;
            --border: #334155;

            /* Grade Colors */
            --g-ex: #22c55e;
            --g-a: #3b82f6;
            --g-b: #a855f7;
            --g-c: #eab308;
            --g-d: #f97316;
            --g-f: #ef4444;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Layout --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .controls {
            width: 350px;
            flex-shrink: 0;
            background: var(--panel-bg);
            border-left: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        h2 { margin: 0 0 10px 0; color: var(--accent); }
        h3 { margin: 0 0 5px 0; color: var(--accent); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Control Elements --- */
        .view-group { display: flex; flex-direction: column; gap: 10px; }

        .view-btn {
            background: #334155;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 15px;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .view-btn:hover { background: #475569; }
        .view-btn.active {
            background: var(--accent);
            color: #0f172a;
            border-color: var(--accent);
        }
        .view-btn.active::after { content: '‚óè'; font-size: 1.2em; }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #0f172a;
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            font-size: 0.9em;
        }
        input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }

        .action-btn {
            margin-top: auto;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .action-btn:hover { background: rgba(56, 189, 248, 0.1); }

        /* --- Views --- */
        .view-section { display: none; height: 100%; }
        .view-section.visible { display: flex; flex-direction: column; }

        /* --- 1. Tables --- */
        .table-wrapper {
            background: var(--panel-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .grade-legend {
            background: #0f172a; padding: 10px 15px; border-bottom: 1px solid var(--border);
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap; font-size: 0.85rem;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; color: #94a3b8; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        
        .table-scroll { overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th { 
            background: #0f172a; 
            position: sticky; top: 0; 
            padding: 8px 10px; 
            text-align: left; 
            color: var(--accent); 
            z-index: 10; 
            font-size: 0.85rem;
        }
        td { 
            padding: 6px 10px; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.85rem;
        }
        tr:hover { background: #334155; }

        /* --- 2. Horizontal Bar Styles --- */
        .h-bar-cell { vertical-align: middle; }
        .h-bar-track {
            background: rgba(51, 65, 85, 0.5); 
            border-radius: 4px;
            height: 12px;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
        }
        .h-bar {
            height: 100%;
            background: linear-gradient(to right, var(--accent), #3b82f6);
            border-radius: 4px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .h-bar-val {
            margin-left: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .show-h-labels .h-bar-val { opacity: 1; }

        /* --- 3. Pie Charts --- */
        .pie-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; overflow-y: auto; padding-bottom: 20px;
        }
        .pie-card {
            background: var(--panel-bg); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px; display: flex;
            flex-direction: column; align-items: center; overflow: visible;
        }
        svg { overflow: visible; }
        .pie-label-text {
            font-size: 13px; fill: #ffffff; font-weight: bold; pointer-events: none;
            text-shadow: 0px 0px 3px rgba(0, 0, 0, 0.8);
            transition: opacity 0.3s;
        }
        .pie-label-val { opacity: 0; transition: opacity 0.2s; }
        .show-values .pie-label-val { opacity: 1; }

        /* --- 4. Box & Whisker Plot --- */
        .box-container {
            flex-grow: 1; background: var(--panel-bg); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
            max-height: 530px; 
        }
        .box-chart-svg { width: 100%; height: 100%; }

        .box-line, .box-whisker, .box-rect, .box-median, .box-label-text {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .box-line { stroke: #64748b; stroke-width: 1; }
        .box-whisker { stroke: var(--text); stroke-width: 2; }
        .box-rect { fill: rgba(56, 189, 248, 0.2); stroke: var(--accent); stroke-width: 2; }
        .box-median { stroke: #fbbf24; stroke-width: 3; }
        .box-axis-text { fill: #94a3b8; font-size: 12px; }
        .box-label { fill: white; font-size: 14px; font-weight: bold; }
        .box-grid { stroke: #334155; stroke-dasharray: 4; stroke-width: 0.5; }

        .box-stat-text {
            fill: #cbd5e1; font-size: 14px; font-weight: bold; text-anchor: middle;
            opacity: 0; transition: all 0.8s, opacity 0.3s;
            pointer-events: none; text-shadow: 0 1px 3px #000;
        }
        .show-box-labels .box-stat-text { opacity: 1; }
        .box-stat-text.med-val { fill: #fbbf24; }

    </style>
</head>
<body>

    <div class="main-content">

        <div id="view-table" class="view-section visible">
            <h2 style="margin-bottom: 20px;">Raw Student Data</h2>
            <div class="table-wrapper">
                <div class="grade-legend">
                    <span style="color:#e2e8f0; font-weight:bold; margin-right:10px;">Grading Key:</span>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-ex)"></div>Ex (>80)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-a)"></div>A (>70)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-b)"></div>B (>60)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-c)"></div>C (>50)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-d)"></div>D (>40)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-f)"></div>Fail (<40)</div>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th> 
                                <th style="width: 150px;">Name</th> 
                                <th>Gender</th>
                                <th>Math</th> <th>Phys</th> <th>Chem</th> <th>Eng</th> <th>Avg%</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-bar" class="view-section">
            <h2 style="margin-bottom: 20px;">Student Performance</h2>
            <div class="table-wrapper">
                <div class="grade-legend">
                    <span style="color:#e2e8f0; font-weight:bold; margin-right:10px;">Grading Key:</span>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-ex)"></div>Ex (>80)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-a)"></div>A (>70)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-b)"></div>B (>60)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-c)"></div>C (>50)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-d)"></div>D (>40)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--g-f)"></div>Fail (<40)</div>
                </div>
                <div class="table-scroll">
                    <table id="barTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th style="width: 150px;">Name</th>
                                <th>Performance (Avg %)</th>
                            </tr>
                        </thead>
                        <tbody id="barBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-pie" class="view-section">
            <h2 style="margin-bottom: 20px;">Class Composition & Grades</h2>
            <div id="pie-grid" class="pie-grid">
                <div class="pie-card">
                    <h3>Gender Ratio</h3>
                    <div id="pie-gender"></div>
                </div>
                <div id="subjectPies" style="display: contents;"></div>
            </div>
        </div>

        <div id="view-box" class="view-section">
            <h2 style="margin-bottom: 20px;">Subject Mark Distributions (Box & Whisker)</h2>
            <div class="box-container" id="boxChartContainer">
                </div>
        </div>

    </div>

    <div class="controls">
        <h2>Dashboard Controls</h2>
        <p style="color:#94a3b8; font-size:0.9em;">Select a visualization view below.</p>

        <div class="view-group">
            <button class="view-btn active" onclick="switchView('table')">Raw Data Table</button>

            <button class="view-btn" onclick="switchView('bar')">Bar Chart (Avg Marks)</button>
            <div class="toggle-row">
                <input type="checkbox" id="checkBarLabels" onchange="toggleLabels('bar', this.checked)">
                <label for="checkBarLabels">Show Bar Labels</label>
            </div>

            <button class="view-btn" onclick="switchView('pie')">Pie Charts (Gender/Sub)</button>
            <div class="toggle-row">
                <input type="checkbox" id="checkPieLabels" onchange="toggleLabels('pie', this.checked)">
                <label for="checkPieLabels">Show Pie Counts</label>
            </div>

            <button class="view-btn" onclick="switchView('box')">Box & Whisker Plots</button>
            <div class="toggle-row">
                <input type="checkbox" id="checkBoxLabels" onchange="toggleLabels('box', this.checked)">
                <label for="checkBoxLabels">Show Box Labels</label>
            </div>
        </div>

        <button class="action-btn" onclick="regenerateData()">Regenerate Data</button>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        const CONFIG = {
            count: 16,
            subs: ['Math', 'Physics', 'Chemistry', 'English'],
            colors: {
                'Ex': '#22c55e', 'A': '#3b82f6', 'B': '#a855f7',
                'C': '#eab308', 'D': '#f97316', 'Fail': '#ef4444',
                'Male': '#38bdf8', 'Female': '#f472b6'
            },
            grades: ['Ex', 'A', 'B', 'C', 'D', 'Fail'],
            genders: ['Male', 'Female']
        };

        // Name Pools for Random Generation
        const NAMES_MALE = ["Aarav", "Vivaan", "Aditya", "Vihaan", "Arjun", "Sai", "Reyansh", "Ayaan", "Krishna", "Ishaan", "Shaurya", "Atharva", "Nirvaan", "Dhruv", "Kabir", "Om", "Rohan", "Kartik", "Daksh", "Veer"];
        const NAMES_FEMALE = ["Diya", "Saanvi", "Ananya", "Aadhya", "Pari", "Kiara", "Myra", "Riya", "Anvi", "Aarya", "Avni", "Aisha", "Kavya", "Mira", "Sara", "Tara", "Nisha", "Pooja", "Isha", "Neha"];

        let students = [];
        
        // State for Pie Chart Tweens
        let currentPieData = {
            gender: { Male: 0, Female: 0 },
            subjects: {} 
        };
        CONFIG.subs.forEach(s => {
            currentPieData.subjects[s] = {};
            CONFIG.grades.forEach(g => currentPieData.subjects[s][g] = 0);
        });

        /* --- DATA LOGIC --- */
        function getGrade(m) {
            if (m > 80) return 'Ex'; if (m > 70) return 'A'; if (m > 60) return 'B';
            if (m > 50) return 'C'; if (m > 40) return 'D'; return 'Fail';
        }

        // Helper: pick random item from array
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

        function initStudents() {
            // Initial generation
            regenerateData(false);
        }

        function regenerateData(animate = true) {
            students = [];
            for(let i=1; i<=CONFIG.count; i++) {
                const gender = Math.random() > 0.5 ? 'Male' : 'Female';
                // Pick a name based on gender
                const name = gender === 'Male' ? pick(NAMES_MALE) : pick(NAMES_FEMALE);
                
                const s = {
                    id: i,
                    name: name,
                    gender: gender,
                    marks: {},
                    avg: 0
                };
                
                let total = 0;
                CONFIG.subs.forEach(sub => {
                    s.marks[sub] = Math.floor(Math.random() * 60) + 40;
                    total += s.marks[sub];
                });
                s.avg = Math.round(total / CONFIG.subs.length);
                students.push(s);
            }
            renderAll(animate);
        }

        /* --- RENDERING --- */
        function renderAll(isUpdate = false) {
            renderTable();
            renderBar(isUpdate);
            renderPies(isUpdate);
            renderBox(isUpdate);
        }

        // 1. Raw Table Render
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            students.forEach(s => {
                let marksHTML = '';
                CONFIG.subs.forEach(sub => marksHTML += `<td>${s.marks[sub]}</td>`);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>#${s.id}</td><td style="font-weight:bold">${s.name}</td><td>${s.gender}</td>${marksHTML}<td style="color:var(--accent); font-weight:bold">${s.avg}%</td>`;
                tbody.appendChild(tr);
            });
        }

        // 2. Horizontal Bar Render (Table Layout)
        function renderBar(isUpdate) {
            const tbody = document.getElementById('barBody');
            
            if (tbody.children.length === 0) {
                // First render
                tbody.innerHTML = '';
                students.forEach(s => {
                    const tr = document.createElement('tr');
                    
                    const tdId = `<td>#${s.id}</td>`;
                    // Add ID to name cell to allow updating text later
                    const tdName = `<td id="bar-name-cell-${s.id}" style="font-weight:bold">${s.name}</td>`;
                    
                    const barHtml = `
                        <div class="h-bar-track">
                            <div id="hbar-${s.id}" class="h-bar" style="width: 0%"></div>
                            <span id="hbar-val-${s.id}" class="h-bar-val">${s.avg}%</span>
                        </div>
                    `;
                    
                    tr.innerHTML = `${tdId}${tdName}<td class="h-bar-cell">${barHtml}</td>`;
                    tbody.appendChild(tr);
                });
                
                // Allow DOM paint then animate
                requestAnimationFrame(() => {
                   students.forEach(s => {
                        const bar = document.getElementById(`hbar-${s.id}`);
                        if(bar) bar.style.width = s.avg + '%';
                    });
                });

            } else {
                // Morph Existing Bars & Update Names
                students.forEach(s => {
                    // Update Name Text (Since regeneration changes names)
                    const nameCell = document.getElementById(`bar-name-cell-${s.id}`);
                    if(nameCell) nameCell.innerText = s.name;

                    // Update Bar Width
                    const bar = document.getElementById(`hbar-${s.id}`);
                    const val = document.getElementById(`hbar-val-${s.id}`);
                    if(bar && val) {
                        bar.style.width = s.avg + '%';
                        val.innerText = s.avg + '%';
                    }
                });
            }
        }

        // 3. Pie Render (Interpolation Morphing)
        function createPieSVGStructure(containerId, keys, radius) {
            const size = radius * 2;
            let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
            keys.forEach(k => {
                const color = CONFIG.colors[k] || '#999';
                svg += `<path id="${containerId}-path-${k}" fill="${color}" stroke="#1e293b" stroke-width="2"></path>`;
            });
            keys.forEach(k => {
                svg += `<text id="${containerId}-label-${k}" opacity="0" text-anchor="middle" dominant-baseline="middle" class="pie-label-text">
                        ${k}<tspan id="${containerId}-val-${k}" class="pie-label-val"></tspan>
                        </text>`;
            });
            svg += `</svg>`;
            return svg;
        }

        function updatePieVisuals(containerId, data, size) {
            const total = Object.values(data).reduce((a, b) => a + b, 0);
            const radius = size * 0.45;
            const center = size / 2;
            let startAngle = 0;

            Object.entries(data).forEach(([key, val]) => {
                const sliceAngle = (val / total) * 360;
                const endAngle = startAngle + sliceAngle;
                
                const pathEl = document.getElementById(`${containerId}-path-${key}`);
                const labelEl = document.getElementById(`${containerId}-label-${key}`);
                const valEl = document.getElementById(`${containerId}-val-${key}`);

                if (!pathEl) return;

                if (val <= 0.01) {
                    pathEl.setAttribute('d', '');
                    labelEl.setAttribute('opacity', '0');
                } else {
                    const x1 = center + radius * Math.cos(Math.PI * startAngle / 180);
                    const y1 = center + radius * Math.sin(Math.PI * startAngle / 180);
                    const x2 = center + radius * Math.cos(Math.PI * endAngle / 180);
                    const y2 = center + radius * Math.sin(Math.PI * endAngle / 180);
                    const largeArc = sliceAngle > 180 ? 1 : 0;
                    
                    let d = "";
                    if (Math.abs(sliceAngle - 360) < 0.1) {
                         d = `M${center},${center - radius} A${radius},${radius} 0 1,1 ${center},${center + radius} A${radius},${radius} 0 1,1 ${center},${center - radius} Z`;
                    } else {
                        d = `M${center},${center} L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z`;
                    }
                    pathEl.setAttribute('d', d);

                    if (sliceAngle > 15) {
                        const midAngle = startAngle + sliceAngle / 2;
                        const radAngle = midAngle * (Math.PI / 180);
                        const labelDist = radius * 0.65;
                        const lx = center + labelDist * Math.cos(radAngle);
                        const ly = center + labelDist * Math.sin(radAngle);
                        
                        labelEl.setAttribute('x', lx);
                        labelEl.setAttribute('y', ly);
                        labelEl.setAttribute('opacity', '1');
                        valEl.textContent = ": " + Math.round(val);
                    } else {
                        labelEl.setAttribute('opacity', '0');
                    }
                }
                startAngle += sliceAngle;
            });
        }

        function tweenPieData(oldData, newData, duration, onUpdate) {
            const startTime = performance.now();
            function loop(now) {
                const elapsed = now - startTime;
                const t = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - t, 3);
                const interpolated = {};
                for (let k in newData) {
                    const start = oldData[k] || 0;
                    const end = newData[k] || 0;
                    interpolated[k] = start + (end - start) * ease;
                }
                onUpdate(interpolated);
                if (t < 1) requestAnimationFrame(loop);
            }
            requestAnimationFrame(loop);
        }

        function renderPies(isUpdate) {
            const targetGender = { Male: 0, Female: 0 };
            students.forEach(s => targetGender[s.gender]++);
            
            const targetSubjects = {};
            CONFIG.subs.forEach(sub => {
                targetSubjects[sub] = {};
                CONFIG.grades.forEach(g => targetSubjects[sub][g] = 0);
                students.forEach(s => targetSubjects[sub][getGrade(s.marks[sub])]++);
            });

            if (!isUpdate || document.getElementById('pie-gender').innerHTML === "") {
                document.getElementById('pie-gender').innerHTML = createPieSVGStructure('p-gen', CONFIG.genders, 110);
                const subCont = document.getElementById('subjectPies');
                subCont.innerHTML = '';
                CONFIG.subs.forEach(sub => {
                    const card = document.createElement('div');
                    card.className = 'pie-card';
                    const id = `p-${sub}`;
                    card.innerHTML = `<h3>${sub} Grades</h3><div id="wrapper-${id}">${createPieSVGStructure(id, CONFIG.grades, 100)}</div>`;
                    subCont.appendChild(card);
                });
                updatePieVisuals('p-gen', targetGender, 220);
                CONFIG.subs.forEach(sub => updatePieVisuals(`p-${sub}`, targetSubjects[sub], 200));
                currentPieData.gender = targetGender;
                currentPieData.subjects = targetSubjects;
            } else {
                const startGender = {...currentPieData.gender};
                tweenPieData(startGender, targetGender, 800, (interp) => {
                    updatePieVisuals('p-gen', interp, 220);
                });
                currentPieData.gender = targetGender;
                CONFIG.subs.forEach(sub => {
                    const startSub = {...currentPieData.subjects[sub]};
                    const targetSub = targetSubjects[sub];
                    tweenPieData(startSub, targetSub, 800, (interp) => {
                        updatePieVisuals(`p-${sub}`, interp, 200);
                    });
                    currentPieData.subjects[sub] = targetSubjects[sub];
                });
            }
        }

        // 4. Box Render (Coordinate Morphing)
        function renderBox(isUpdate) {
            const container = document.getElementById('boxChartContainer');
            if (!container.clientWidth) return;

            const w = container.clientWidth;
            const h = container.clientHeight || 530; // Matches CSS max-height
            const padL = 60, padR = 20, padT = 20, padB = 40;
            const plotW = w - padL - padR;
            const plotH = h - padT - padB;
            const sectionH = plotH / CONFIG.subs.length;

            let svg = document.getElementById('mainBoxSvg');
            if (!svg) {
                let gridSvg = '';
                for (let i = 0; i <= 100; i += 20) {
                    const x = padL + (i / 100) * plotW;
                    gridSvg += `<line x1="${x}" y1="${padT}" x2="${x}" y2="${padT + plotH}" class="box-grid" />`;
                    gridSvg += `<text x="${x}" y="${padT + plotH + 20}" text-anchor="middle" class="box-axis-text">${i}%</text>`;
                }
                container.innerHTML = `<svg id="mainBoxSvg" class="box-chart-svg" viewBox="0 0 ${w} ${h}">${gridSvg}</svg>`;
                svg = document.getElementById('mainBoxSvg');
            }

            CONFIG.subs.forEach((sub, i) => {
                const marks = students.map(s => s.marks[sub]).sort((a, b) => a - b);
                const min = marks[0];
                const max = marks[marks.length - 1];
                const q1 = marks[Math.floor((marks.length - 1) * 0.25)];
                const q3 = marks[Math.floor((marks.length - 1) * 0.75)];
                const med = marks[Math.floor((marks.length - 1) * 0.5)];

                const yCenter = padT + (i * sectionH) + (sectionH / 2);
                const xMin = padL + (min / 100) * plotW;
                const xMax = padL + (max / 100) * plotW;
                const xQ1 = padL + (q1 / 100) * plotW;
                const xQ3 = padL + (q3 / 100) * plotW;
                const xMed = padL + (med / 100) * plotW;

                let group = document.getElementById(`box-group-${sub}`);
                
                if (!group) {
                    group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    group.id = `box-group-${sub}`;
                    group.className = 'box-group';
                    
                    // Increased Height to 50, Split whiskers into Left and Right
                    group.innerHTML = `
                        <text class="box-label" x="${padL-10}" y="${yCenter+5}" text-anchor="end">${sub}</text>
                        
                        <line id="${sub}-w-left" class="box-whisker" />
                        <line id="${sub}-w-right" class="box-whisker" />
                        
                        <line id="${sub}-c-min" class="box-whisker" />
                        <line id="${sub}-c-max" class="box-whisker" />
                        
                        <rect id="${sub}-rect" class="box-rect" height="50" />
                        
                        <line id="${sub}-med" class="box-median" />
                        
                        <text id="${sub}-t-min" class="box-stat-text">0</text>
                        <text id="${sub}-t-q1" class="box-stat-text">0</text>
                        <text id="${sub}-t-med" class="box-stat-text med-val">0</text>
                        <text id="${sub}-t-q3" class="box-stat-text">0</text>
                        <text id="${sub}-t-max" class="box-stat-text">0</text>
                    `;
                    svg.appendChild(group);
                }

                const setAttr = (id, attrs) => {
                    const el = document.getElementById(id);
                    if(el) for(let k in attrs) el.setAttribute(k, attrs[k]);
                };

                // Left Whisker: Min to Q1 (Stops at box edge)
                setAttr(`${sub}-w-left`, { x1: xMin, y1: yCenter, x2: xQ1, y2: yCenter });
                
                // Right Whisker: Q3 to Max (Starts at box edge)
                setAttr(`${sub}-w-right`, { x1: xQ3, y1: yCenter, x2: xMax, y2: yCenter });

                // Caps (Vertical lines at ends) - Slightly shorter than box height (50/2 = 25, caps are +/- 15)
                setAttr(`${sub}-c-min`, { x1: xMin, y1: yCenter-15, x2: xMin, y2: yCenter+15 });
                setAttr(`${sub}-c-max`, { x1: xMax, y1: yCenter-15, x2: xMax, y2: yCenter+15 });
                
                // Box (Height 50, so offset is -25)
                setAttr(`${sub}-rect`, { x: xQ1, y: yCenter-25, width: Math.max(0, xQ3-xQ1) });
                
                // Median Line
                setAttr(`${sub}-med`, { x1: xMed, y1: yCenter-25, x2: xMed, y2: yCenter+25 });

                const updateLabel = (suffix, val, xPos, yOffset) => {
                    const el = document.getElementById(`${sub}-t-${suffix}`);
                    el.setAttribute('x', xPos);
                    el.setAttribute('y', yCenter + yOffset);
                    el.textContent = val;
                };

                updateLabel('min', min, xMin, -20);
                updateLabel('max', max, xMax, -20);
                updateLabel('med', med, xMed, -30);
                updateLabel('q1', q1, xQ1, 40);
                updateLabel('q3', q3, xQ3, 40);
            });
        }

        /* --- UI INTERACTION --- */
        function switchView(viewId) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            const map = {'table':0, 'bar':1, 'pie':2, 'box':3};
            document.querySelectorAll('.view-btn')[map[viewId]].classList.add('active');

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('visible'));
            document.getElementById('view-' + viewId).classList.add('visible');

            if (viewId === 'bar') renderBar(true);
            if (viewId === 'box') renderBox(true);
        }

        function toggleLabels(type, isChecked) {
            if (type === 'bar') {
                const el = document.getElementById('barTable');
                isChecked ? el.classList.add('show-h-labels') : el.classList.remove('show-h-labels');
            } else if (type === 'pie') {
                const grid = document.getElementById('pie-grid');
                isChecked ? grid.classList.add('show-values') : grid.classList.remove('show-values');
            } else if (type === 'box') {
                const con = document.getElementById('boxChartContainer');
                isChecked ? con.classList.add('show-box-labels') : con.classList.remove('show-box-labels');
            }
        }

        window.addEventListener('resize', () => {
            if (document.getElementById('view-box').classList.contains('visible')) {
                document.getElementById('boxChartContainer').innerHTML = '';
                renderBox(false);
            }
        });

        // Initialize with Static Students
        initStudents();
        renderAll();

    </script>
</body>
</html>
